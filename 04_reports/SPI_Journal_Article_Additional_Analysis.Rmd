---
title: "SPI Journal Article - Supplmental Tables & Figures"
author: "SPI Team"
date: "`r Sys.Date()`"
output:
  bookdown::word_document2: 
    toc: yes
    fig_width: 9
    fig_height: 6
    number_sections: true

---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6, fig.cap = "")
library(tidyverse)
library(flextable)
library(here)
# devtools::install_github("worldbank/wbgviz", subdir = "wbgdata")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgcharts")
# devtools::install_github("worldbank/wbgviz", subdir = "wbggeo")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgmaps")
# library(wbggeo)
# library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(haven)
library(zoo)
library(estimatr)
library(ggpmisc)
library(ggthemes)
library(ggtext)
library(fixest)
library(modelsummary)
library(WDI)

#set directories
dir <- here()
raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")
#weights (either unity (1) or population)
wgt <- 1
```


```{r load, include=FALSE}
#add in population
pop_df <- wbstats::wb_data(country="all",
             indicator='SP.POP.TOTL',
             start_date=2004,
             end_date=2022) %>%
  mutate(date=as.numeric(date)) %>%
  mutate(population=SP.POP.TOTL) %>%
  select(country, date, population) 
#import data
spi_index_df <- read_csv(paste(output_dir, 'SPI_index.csv', sep="/")) %>%
    left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.
#read in the SPI dataset
spi_df_final <- read_csv( file = paste(output_dir, 'SPI_data.csv', sep="/")) %>%
  left_join(pop_df) %>%
  mutate(weights=wgt,
         income=income_level)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.
#metadata 

metadata <- read_csv(paste(raw_dir, '/metadata/SPI_dimensions_sources.csv', sep=""))

metadata_full <- read_csv(paste(raw_dir, '/metadata/SPI_index_sources.csv', sep="")) %>%
  rename(source_name=descript) %>%
  bind_rows(metadata)

metadata <- data.frame(
  series = c('SPI.INDEX', 'SPI.INDEX.PIL1', 'SPI.INDEX.PIL2', 'SPI.INDEX.PIL3', 'SPI.INDEX.PIL4', 'SPI.INDEX.PIL5'),
  indicator_name = c('SPI Overall Score', 'Pillar 1: Data Use', 'Pillar 2: Data Services', 'Pillar 3: Data Products', 'Pillar 4: Data Sources', 'Pillar 5: Data Infrastructure')
)
#get list of country info
country_list <- wbstats::wb_countries()



SPI <- spi_index_df 

SPI_2022 <- SPI %>% 
  filter(date==2022) %>% 
  filter(!is.na(SPI.INDEX))

#read in TopoJSON from World Bank
#countries <- geojsonio::geojson_read("WB_countries_Admin0_lowres.geojson",
#                                     what = "sp")
```

## SDG Indicator Weights Sensitivity Check

In this sensitivity check, alternative weights to the SPI overall score will be considered, where SDGs are given alternative weights.

In the preferred version of the SPI overall score, a score for each pillar is subsequently computed as the average score of the dimensions in that pillar. For pillars 1, 2, 4, and 5, the unweighted average of the dimensions within each pillar is taken.  For pillar 3 on data products, we take a weighted average of the dimensions, where the weights are based on the number of SDGs in each dimension (6 SDGs in dimension 3.1 on social statistics, 6 SDGs in dimension 3.2 on economic statistics, 2 in dimension 3.3 on environmental statistics, and 2 in dimension 3.4 on institutional statistics).   This reflects a perspective that all SDGs are of equal importance, and therefore the dimensions are weighted accordingly. Additionally, for Pillar 4 on data sources, censuses and surveys are given separate weights, so that censuses, surveys, administrative data, and geospatial data each receives a weight of 1/4. While censuses and surveys are in the same pillar in the framework, and therefore each would typically only receive a weight of 1/6 in this dimension, because of their importance in producing many indicators, they are given extra weight such that each gets a weight of 1/4. The score for each pillar (SPI.PIL_{ctp}) is calculated as follows.

In the alternative version to follow, Pillar 3 is constructed so that 1/4 weight is given to each of what we classify as Social (SDG 1-6), Economic (SDG 7-12), Environmental (SDG 13-15), and Institution (SDG 16-17).  Within each of the four groups (Social, Economic, Environmental, and Institution), the SDGs in that group are given equal weight.  For instance, the Social index score is the unweighted average of the score for SDG 1, SDG 2, SDG 3, SDG 4, SDG 5, and SDG 6.  The weights for each SDG in the preferred version of Pillar 3 shown in the body of the paper and the alternative version described above is shown in the table below.

**Table. Pillar 3 Weights for the SDGs Under Preferred and Alternative Specifications.**    

| Goal | Weight for Preferred Specification | Weight for Alternative Specification |
|---|---|---|
| SDG 1 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 2 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 3 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 4 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 5 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 6 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 7 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 8 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 9 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 10 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 11 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 12 | 1/16 | 1/24 = (1/4 * 1/6) |
| SDG 13 | 1/16 | 1/8 = (1/4 * 1/2) |
| SDG 14 | excluded | excluded |
| SDG 15 | 1/16 | 1/8 = (1/4 * 1/2) |
| SDG 16 | 1/16 | 1/8 = (1/4 * 1/2) |
| SDG 17 | 1/16 | 1/8 = (1/4 * 1/2) |




```{r index_weights_alt1}

#Pillar 1 - Overall Weight
pillar_1 <- 1/5
#Dimension 1.5: Data Use by International Organizations
dim_1_5 <- 1

#Dimension 2 - Overall Weight
pillar_2 <- 1/5
#Dimension 2.1: Data releases
dim_2_1 <- 1/3
#Dimension 2.2: Online access
dim_2_2 <- 1/3
# Dimension 2.4: Data services
dim_2_4 <- 1/3

# Dimension 3 - Overall Weight
pillar_3 <- 1/5
# Dimension 3: SDG 1
dim_3_1 <- 1/24
# Dimension 3: SDG 2
dim_3_2 <- 1/24
# Dimension 3: SDG 3
dim_3_3 <- 1/24
# Dimension 3: SDG 4
dim_3_4 <- 1/24
# Dimension 3: SDG 5
dim_3_5 <- 1/24
# Dimension 3: SDG 6
dim_3_6 <- 1/24
# Dimension 3: SDG 7
dim_3_7 <- 1/24
# Dimension 3: SDG 8
dim_3_8 <- 1/24
# Dimension 3: SDG 9
dim_3_9 <- 1/24
# Dimension 3: SDG 10
dim_3_10 <- 1/24
# Dimension 3: SDG 11
dim_3_11 <- 1/24
# Dimension 3: SDG 12
dim_3_12 <- 1/24
# Dimension 3: SDG 13
dim_3_13 <- 1/8
# Dimension 3: SDG 15
dim_3_15 <- 1/8
# Dimension 3: SDG 16
dim_3_16 <- 1/8
# Dimension 3: SDG 17
dim_3_17 <- 1/8

#Dimension 4 - Overall Weight
pillar_4 <- 1/5
# Dimension 4.1: censuses and surveys
dim_4_1.CEN <- 1/4
dim_4_1.SVY <- 1/4
#Dimension 4.2: administrative data
dim_4_2 <- 1/4
# Dimension 4.3: geospatial data
dim_4_3 <- 1/4

# Dimension 5 - Overall Weight
pillar_5 <- 1/5
# Dimension 5.2: Standards and Methods
dim_5_1 <- 0
dim_5_2 <- 1
dim_5_5 <- 0


```
  

```{r index_alt1}

# create index dataset
spi_index_df_temp <- spi_df_final %>%
  select(country, iso3c, date, starts_with("SPI"), income, region, weights, population) %>%
  arrange(-date,country)

#Drop certain indicators that don't make cut because of imcomplete coverage usually
spi_index_df_temp <- spi_index_df_temp %>%
  select( -SPI.D5.3.DISK, -SPI.D4.3.GEO.second.admin.level) 



#################
# Nested Index
################
spi_index_alt1_df <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  select(country, iso3c, date, everything())



#recalculate index based on the weights
pillar_total <- pillar_1 + pillar_2 + pillar_3 + pillar_4 + pillar_5
pillar2_total <- dim_2_1 + dim_2_2 + dim_2_4
pillar3_total <- 
  dim_3_1 + 
  dim_3_2 +
  dim_3_3 +
  dim_3_4 +
  dim_3_5 +
  dim_3_6 +
  dim_3_7 +
  dim_3_8 +
  dim_3_9 +
  dim_3_10 +
  dim_3_11 +
  dim_3_12 +
  dim_3_13 +
  dim_3_15 +
  dim_3_16 +
  dim_3_17
pillar4_total <- dim_4_1.CEN + dim_4_1.SVY + + dim_4_2 + dim_4_3
pillar5_total <- dim_5_1 + dim_5_2 + dim_5_5

#create index dataset
spi_index_alt1_df <- spi_index_alt1_df %>%
  mutate(SPI.DIM1.5.INDEX=rowMeans(across(starts_with("SPI.D1.5")), na.rm=FALSE),
         SPI.DIM2.1.INDEX=rowMeans(across(starts_with('SPI.D2.1'))),
         SPI.DIM2.2.INDEX=SPI.D2.2.Openness.subscore,
         SPI.DIM2.4.INDEX=SPI.D2.4.NADA,
         SPI.DIM3.1.INDEX=rowMeans(across(c("SPI.D3.1.POV",
                                          "SPI.D3.2.HNGR",
                                          "SPI.D3.3.HLTH",
                                          "SPI.D3.4.EDUC",
                                          "SPI.D3.5.GEND",
                                          "SPI.D3.6.WTRS"))),
         SPI.DIM3.2.INDEX=rowMeans(across(c("SPI.D3.7.ENRG",
                                          "SPI.D3.8.WORK",
                                          "SPI.D3.9.INDY",
                                          "SPI.D3.10.NEQL",
                                          "SPI.D3.11.CITY",
                                          "SPI.D3.12.CNSP"))),         
         SPI.DIM3.3.INDEX=rowMeans(across(c("SPI.D3.13.CLMT",
                                          "SPI.D3.15.LAND" ))),
         SPI.DIM3.4.INDEX=rowMeans(across(c("SPI.D3.16.INST",
                                          "SPI.D3.17.PTNS" ))),
         SPI.DIM4.1.CEN.INDEX=rowMeans(across(c('SPI.D4.1.1.POPU','SPI.D4.1.2.AGRI','SPI.D4.1.3.BIZZ'))), #separate census and surveys 
         SPI.DIM4.1.SVY.INDEX=rowMeans(across(c('SPI.D4.1.4.HOUS','SPI.D4.1.5.AGSVY','SPI.D4.1.6.LABR', 'SPI.D4.1.7.HLTH','SPI.D4.1.8.BZSVY'))), #separate census and surveys 
         SPI.DIM4.2.INDEX=rowMeans(across(starts_with('SPI.D4.2'))),
         SPI.DIM4.3.INDEX=rowMeans(across(starts_with('SPI.D4.3'))),
         
         SPI.DIM5.1.INDEX=rowMeans(across(starts_with('SPI.D5.1'))),
         SPI.DIM5.1.INDEX=if_else(is.na(SPI.DIM5.1.INDEX),-99,SPI.DIM5.1.INDEX),
         
         SPI.DIM5.2.INDEX=rowMeans(across(starts_with('SPI.D5.2'))),
         
         SPI.DIM5.5.INDEX=rowMeans(across(starts_with('SPI.D5.5'))),
         SPI.DIM5.5.INDEX=if_else(is.na(SPI.DIM5.5.INDEX),-99,SPI.DIM5.5.INDEX) 
             ) %>%
  mutate(
    SPI.INDEX.PIL1.ALT1=SPI.DIM1.5.INDEX,
    SPI.INDEX.PIL2.ALT1=(
      (dim_2_1/pillar2_total)*SPI.DIM2.1.INDEX +
        (dim_2_2/pillar2_total)*SPI.DIM2.2.INDEX +
        (dim_2_4/pillar2_total)*SPI.DIM2.4.INDEX )
    ,
    SPI.INDEX.PIL3.ALT1=(
      (dim_3_1/pillar3_total)*SPI.D3.1.POV +
        (dim_3_2/pillar3_total)*SPI.D3.2.HNGR +
        (dim_3_3/pillar3_total)*SPI.D3.3.HLTH +
        (dim_3_4/pillar3_total)*SPI.D3.4.EDUC +
        (dim_3_5/pillar3_total)*SPI.D3.5.GEND +
        (dim_3_6/pillar3_total)*SPI.D3.6.WTRS +
        (dim_3_7/pillar3_total)*SPI.D3.7.ENRG +
        (dim_3_8/pillar3_total)*SPI.D3.8.WORK +
        (dim_3_9/pillar3_total)*SPI.D3.9.INDY +
        (dim_3_10/pillar3_total)*SPI.D3.10.NEQL +
        (dim_3_11/pillar3_total)*SPI.D3.11.CITY +
        (dim_3_12/pillar3_total)*SPI.D3.12.CNSP +
        (dim_3_13/pillar3_total)*SPI.D3.13.CLMT +
        (dim_3_15/pillar3_total)*SPI.D3.15.LAND +
        (dim_3_16/pillar3_total)*SPI.D3.16.INST +
        (dim_3_17/pillar3_total)*SPI.D3.17.PTNS)
    ,
    SPI.INDEX.PIL4.ALT1=(
      (dim_4_1.CEN/pillar4_total)*SPI.DIM4.1.CEN.INDEX +
      (dim_4_1.SVY/pillar4_total)*SPI.DIM4.1.SVY.INDEX +
        (dim_4_2/pillar4_total)*SPI.DIM4.2.INDEX +
        (dim_4_3/pillar4_total)*SPI.DIM4.3.INDEX )
    ,
    SPI.INDEX.PIL5.ALT1=(
      (dim_5_1/pillar5_total)*SPI.DIM5.1.INDEX +
        (dim_5_2/pillar5_total)*SPI.DIM5.2.INDEX +
        (dim_5_5/pillar5_total)*SPI.DIM5.5.INDEX ),
    SPI.INDEX.ALT1=(pillar_1/pillar_total)*SPI.INDEX.PIL1.ALT1 +
      (pillar_2/pillar_total)*SPI.INDEX.PIL2.ALT1 +
      (pillar_3/pillar_total)*SPI.INDEX.PIL3.ALT1 +
      (pillar_4/pillar_total)*SPI.INDEX.PIL4.ALT1 +
      (pillar_5/pillar_total)*SPI.INDEX.PIL5.ALT1 
    #sum up based on individual dimension weights
  ) %>% #
  mutate(across(starts_with('SPI.INDEX'),~100*.)) %>%
  arrange(-date, -SPI.INDEX.ALT1) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX')) 
  #  filter(date>=2016) #2016 is first year with complete data



```

```{r}

alt1_comp_df <- spi_index_alt1_df %>%
  filter(date==2022) %>%
  left_join(SPI_2022)
  

#correlations
cor_ovrl <- cor(alt1_comp_df$SPI.INDEX, alt1_comp_df$SPI.INDEX.ALT1, use='pairwise.complete' )
cor_p1 <- cor(alt1_comp_df$SPI.INDEX.PIL1, alt1_comp_df$SPI.INDEX.PIL1.ALT1, use='pairwise.complete' )
cor_p2 <- cor(alt1_comp_df$SPI.INDEX.PIL2, alt1_comp_df$SPI.INDEX.PIL2.ALT1, use='pairwise.complete' )
cor_p3 <- cor(alt1_comp_df$SPI.INDEX.PIL3, alt1_comp_df$SPI.INDEX.PIL3.ALT1, use='pairwise.complete' )
cor_p4 <- cor(alt1_comp_df$SPI.INDEX.PIL4, alt1_comp_df$SPI.INDEX.PIL4.ALT1, use='pairwise.complete' )
cor_p5 <- cor(alt1_comp_df$SPI.INDEX.PIL5, alt1_comp_df$SPI.INDEX.PIL5.ALT1, use='pairwise.complete' )
```
The correlation between the Pillar 3 score for 2022 between the preferred measure and the alternative measure is `r round(cor_p3,3)`, and the correlation between the SPI overall score under the preferred approach and the alternative approach is `r round(cor_ovrl,3)`.  The figure below shows the scatter plot between the preferred and alternative scores for Pillar 3.

```{r}

ggplot(alt1_comp_df, aes(x=SPI.INDEX.PIL3, y=SPI.INDEX.PIL3.ALT1)) +
  geom_point(alpha=0.3, color="#e76f51") +
  #geom_text_repel(aes(label=iso3c), size=3, box.padding=0.01, point.padding = 0.01, label_padding=0.01, max.overlaps = 25 ) +
  geom_text(aes(label=iso3c), color="#264653",position=position_jitter(width=.2,height=.6), check_overlap=T) +
  theme_bw() +
  xlab('SPI PIllar 3 Score - Preferred') +
  ylab('SPI PIllar 3 Score - Alternative') +
  expand_limits(x=c(0,100), y=c(0,100)) +
  labs(title = "SPI Pillar 3 Scores in 2022 for Preferred and Alternative SDG Weights",
       caption= str_wrap("Under the preferred approach, each SDG receives a weight of 1/16.  Under the alternative approach,Pillar 3 is constructed so that 1/4 weight is given to each of what we classify as Social (SDG 1-6), Economic (SDG 7-12), Environmental (SDG 13-15), and Institution (SDG 16-17).  Within each of the four groups (Social, Economic, Environmental, and Institution), the SDGs in that group are given equal weight.", 110))

```


## Pillar 4, Census and Survey  Weights Sensitivity Check

In this sensitivity check, alternative weights to the SPI overall score will be considered, where the indicator for censuses and surveys are each given weight of 1/6, rather than 1/4.

In the preferred version of the SPI overall score, a score for each pillar is subsequently computed as the average score of the dimensions in that pillar. For pillars 1, 2, 4, and 5, the unweighted average of the dimensions within each pillar is taken.  For pillar 3 on data products, we take a weighted average of the dimensions, where the weights are based on the number of SDGs in each dimension (6 SDGs in dimension 3.1 on social statistics, 6 SDGs in dimension 3.2 on economic statistics, 2 in dimension 3.3 on environmental statistics, and 2 in dimension 3.4 on institutional statistics).   This reflects a perspective that all SDGs are of equal importance, and therefore the dimensions are weighted accordingly. Additionally, for Pillar 4 on data sources, censuses and surveys are given separate weights, so that censuses, surveys, administrative data, and geospatial data each receives a weight of 1/4. While censuses and surveys are in the same pillar in the framework, and therefore each would typically only receive a weight of 1/6 in this dimension, because of their importance in producing many indicators, they are given extra weight such that each gets a weight of 1/4. The score for each pillar (SPI.PIL_{ctp}) is calculated as follows.

In the alternative version to follow, Pillar 4 is constructed so that 1/6 weight is given to censuses, 1/6 weight is given to surveys, 1/3 weight is given to administrative data, and 1/3 weight is given to geospatial data. The weights for each indicator in the preferred version of Pillar 4 shown in the body of the paper and the alternative version described above is shown in the table below.

**Table. Pillar 4 Weights for Indicators Under Preferred and Alternative Specifications.**    

| Indicator | Weight for Preferred Specification | Weight for Alternative Specification |
|---|---|---|
| Censuses | 1/4 | 1/6 = (1/2 * 1/3) |
| Surveys | 1/4 | 1/24 = (1/2 * 1/3) |
| Administrative Data | 1/4 | 1/3 |
| Geospatial Data | 1/4 | 1/3 |





```{r index_weights_alt2}

#Pillar 1 - Overall Weight
pillar_1 <- 1/5
#Dimension 1.5: Data Use by International Organizations
dim_1_5 <- 1

#Dimension 2 - Overall Weight
pillar_2 <- 1/5
#Dimension 2.1: Data releases
dim_2_1 <- 1/3
#Dimension 2.2: Online access
dim_2_2 <- 1/3
# Dimension 2.4: Data services
dim_2_4 <- 1/3

# Dimension 3 - Overall Weight
pillar_3 <- 1/5
# Dimension 3: SDG 1
dim_3_1 <- 1/24
# Dimension 3: SDG 2
dim_3_2 <- 1/24
# Dimension 3: SDG 3
dim_3_3 <- 1/24
# Dimension 3: SDG 4
dim_3_4 <- 1/24
# Dimension 3: SDG 5
dim_3_5 <- 1/24
# Dimension 3: SDG 6
dim_3_6 <- 1/24
# Dimension 3: SDG 7
dim_3_7 <- 1/24
# Dimension 3: SDG 8
dim_3_8 <- 1/24
# Dimension 3: SDG 9
dim_3_9 <- 1/24
# Dimension 3: SDG 10
dim_3_10 <- 1/24
# Dimension 3: SDG 11
dim_3_11 <- 1/24
# Dimension 3: SDG 12
dim_3_12 <- 1/24
# Dimension 3: SDG 13
dim_3_13 <- 1/8
# Dimension 3: SDG 15
dim_3_15 <- 1/8
# Dimension 3: SDG 16
dim_3_16 <- 1/8
# Dimension 3: SDG 17
dim_3_17 <- 1/8

#Dimension 4 - Overall Weight
pillar_4 <- 1/5
# Dimension 4.1: censuses and surveys
dim_4_1.CEN <- 1/6
dim_4_1.SVY <- 1/6
#Dimension 4.2: administrative data
dim_4_2 <- 1/3
# Dimension 4.3: geospatial data
dim_4_3 <- 1/3

# Dimension 5 - Overall Weight
pillar_5 <- 1/5
# Dimension 5.2: Standards and Methods
dim_5_1 <- 0
dim_5_2 <- 1
dim_5_5 <- 0


```
  

```{r index_alt2}

# create index dataset
spi_index_df_temp <- spi_df_final %>%
  select(country, iso3c, date, starts_with("SPI"), income, region, weights, population) %>%
  arrange(-date,country)

#Drop certain indicators that don't make cut because of imcomplete coverage usually
spi_index_df_temp <- spi_index_df_temp %>%
  select( -SPI.D5.3.DISK, -SPI.D4.3.GEO.second.admin.level) 



#################
# Nested Index
################
spi_index_alt1_df <- spi_index_df_temp %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("SPI"), na.locf, na.rm=FALSE)) %>%
  select(country, iso3c, date, everything())



#recalculate index based on the weights
pillar_total <- pillar_1 + pillar_2 + pillar_3 + pillar_4 + pillar_5
pillar2_total <- dim_2_1 + dim_2_2 + dim_2_4
pillar3_total <- 
  dim_3_1 + 
  dim_3_2 +
  dim_3_3 +
  dim_3_4 +
  dim_3_5 +
  dim_3_6 +
  dim_3_7 +
  dim_3_8 +
  dim_3_9 +
  dim_3_10 +
  dim_3_11 +
  dim_3_12 +
  dim_3_13 +
  dim_3_15 +
  dim_3_16 +
  dim_3_17
pillar4_total <- dim_4_1.CEN + dim_4_1.SVY + + dim_4_2 + dim_4_3
pillar5_total <- dim_5_1 + dim_5_2 + dim_5_5

#create index dataset
spi_index_alt2_df <- spi_index_alt1_df %>%
  mutate(SPI.DIM1.5.INDEX=rowMeans(across(starts_with("SPI.D1.5")), na.rm=FALSE),
         SPI.DIM2.1.INDEX=rowMeans(across(starts_with('SPI.D2.1'))),
         SPI.DIM2.2.INDEX=SPI.D2.2.Openness.subscore,
         SPI.DIM2.4.INDEX=SPI.D2.4.NADA,
         SPI.DIM3.1.INDEX=rowMeans(across(c("SPI.D3.1.POV",
                                          "SPI.D3.2.HNGR",
                                          "SPI.D3.3.HLTH",
                                          "SPI.D3.4.EDUC",
                                          "SPI.D3.5.GEND",
                                          "SPI.D3.6.WTRS"))),
         SPI.DIM3.2.INDEX=rowMeans(across(c("SPI.D3.7.ENRG",
                                          "SPI.D3.8.WORK",
                                          "SPI.D3.9.INDY",
                                          "SPI.D3.10.NEQL",
                                          "SPI.D3.11.CITY",
                                          "SPI.D3.12.CNSP"))),         
         SPI.DIM3.3.INDEX=rowMeans(across(c("SPI.D3.13.CLMT",
                                          "SPI.D3.15.LAND" ))),
         SPI.DIM3.4.INDEX=rowMeans(across(c("SPI.D3.16.INST",
                                          "SPI.D3.17.PTNS" ))),
         SPI.DIM4.1.CEN.INDEX=rowMeans(across(c('SPI.D4.1.1.POPU','SPI.D4.1.2.AGRI','SPI.D4.1.3.BIZZ'))), #separate census and surveys 
         SPI.DIM4.1.SVY.INDEX=rowMeans(across(c('SPI.D4.1.4.HOUS','SPI.D4.1.5.AGSVY','SPI.D4.1.6.LABR', 'SPI.D4.1.7.HLTH','SPI.D4.1.8.BZSVY'))), #separate census and surveys 
         SPI.DIM4.2.INDEX=rowMeans(across(starts_with('SPI.D4.2'))),
         SPI.DIM4.3.INDEX=rowMeans(across(starts_with('SPI.D4.3'))),
         
         SPI.DIM5.1.INDEX=rowMeans(across(starts_with('SPI.D5.1'))),
         SPI.DIM5.1.INDEX=if_else(is.na(SPI.DIM5.1.INDEX),-99,SPI.DIM5.1.INDEX),
         
         SPI.DIM5.2.INDEX=rowMeans(across(starts_with('SPI.D5.2'))),
         
         SPI.DIM5.5.INDEX=rowMeans(across(starts_with('SPI.D5.5'))),
         SPI.DIM5.5.INDEX=if_else(is.na(SPI.DIM5.5.INDEX),-99,SPI.DIM5.5.INDEX) 
             ) %>%
  mutate(
    SPI.INDEX.PIL1.ALT2=SPI.DIM1.5.INDEX,
    SPI.INDEX.PIL2.ALT2=(
      (dim_2_1/pillar2_total)*SPI.DIM2.1.INDEX +
        (dim_2_2/pillar2_total)*SPI.DIM2.2.INDEX +
        (dim_2_4/pillar2_total)*SPI.DIM2.4.INDEX )
    ,
    SPI.INDEX.PIL3.ALT2=(
      (dim_3_1/pillar3_total)*SPI.D3.1.POV +
        (dim_3_2/pillar3_total)*SPI.D3.2.HNGR +
        (dim_3_3/pillar3_total)*SPI.D3.3.HLTH +
        (dim_3_4/pillar3_total)*SPI.D3.4.EDUC +
        (dim_3_5/pillar3_total)*SPI.D3.5.GEND +
        (dim_3_6/pillar3_total)*SPI.D3.6.WTRS +
        (dim_3_7/pillar3_total)*SPI.D3.7.ENRG +
        (dim_3_8/pillar3_total)*SPI.D3.8.WORK +
        (dim_3_9/pillar3_total)*SPI.D3.9.INDY +
        (dim_3_10/pillar3_total)*SPI.D3.10.NEQL +
        (dim_3_11/pillar3_total)*SPI.D3.11.CITY +
        (dim_3_12/pillar3_total)*SPI.D3.12.CNSP +
        (dim_3_13/pillar3_total)*SPI.D3.13.CLMT +
        (dim_3_15/pillar3_total)*SPI.D3.15.LAND +
        (dim_3_16/pillar3_total)*SPI.D3.16.INST +
        (dim_3_17/pillar3_total)*SPI.D3.17.PTNS)
    ,
    SPI.INDEX.PIL4.ALT2=(
      (dim_4_1.CEN/pillar4_total)*SPI.DIM4.1.CEN.INDEX +
      (dim_4_1.SVY/pillar4_total)*SPI.DIM4.1.SVY.INDEX +
        (dim_4_2/pillar4_total)*SPI.DIM4.2.INDEX +
        (dim_4_3/pillar4_total)*SPI.DIM4.3.INDEX )
    ,
    SPI.INDEX.PIL5.ALT2=(
      (dim_5_1/pillar5_total)*SPI.DIM5.1.INDEX +
        (dim_5_2/pillar5_total)*SPI.DIM5.2.INDEX +
        (dim_5_5/pillar5_total)*SPI.DIM5.5.INDEX ),
    SPI.INDEX.ALT2=(pillar_1/pillar_total)*SPI.INDEX.PIL1.ALT2 +
      (pillar_2/pillar_total)*SPI.INDEX.PIL2.ALT2 +
      (pillar_3/pillar_total)*SPI.INDEX.PIL3.ALT2 +
      (pillar_4/pillar_total)*SPI.INDEX.PIL4.ALT2 +
      (pillar_5/pillar_total)*SPI.INDEX.PIL5.ALT2 
    #sum up based on individual dimension weights
  ) %>% #
  mutate(across(starts_with('SPI.INDEX'),~100*.)) %>%
  arrange(-date, -SPI.INDEX.ALT2) %>%
  select(country, iso3c, date, starts_with('SPI.INDEX')) 
  #  filter(date>=2016) #2016 is first year with complete data



```

```{r}

alt2_comp_df <- spi_index_alt2_df %>%
  filter(date==2022) %>%
  left_join(SPI_2022)
  

#correlations
cor_ovrl <- cor(alt2_comp_df$SPI.INDEX, alt2_comp_df$SPI.INDEX.ALT2, use='pairwise.complete' )
cor_p1 <- cor(alt2_comp_df$SPI.INDEX.PIL1, alt2_comp_df$SPI.INDEX.PIL1.ALT2, use='pairwise.complete' )
cor_p2 <- cor(alt2_comp_df$SPI.INDEX.PIL2, alt2_comp_df$SPI.INDEX.PIL2.ALT2, use='pairwise.complete' )
cor_p3 <- cor(alt2_comp_df$SPI.INDEX.PIL3, alt2_comp_df$SPI.INDEX.PIL3.ALT2, use='pairwise.complete' )
cor_p4 <- cor(alt2_comp_df$SPI.INDEX.PIL4, alt2_comp_df$SPI.INDEX.PIL4.ALT2, use='pairwise.complete' )
cor_p5 <- cor(alt2_comp_df$SPI.INDEX.PIL5, alt2_comp_df$SPI.INDEX.PIL5.ALT2, use='pairwise.complete' )
```
The correlation between the Pillar 4 score for 2022 between the preferred measure and the alternative measure is `r round(cor_p3,3)`, and the correlation between the SPI overall score under the preferred approach and the alternative approach is `r round(cor_ovrl,3)`.  The figure below shows the scatter plot between the preferred and alternative scores for Pillar 4.

```{r}

ggplot(alt2_comp_df, aes(x=SPI.INDEX.PIL4, y=SPI.INDEX.PIL4.ALT2)) +
  geom_point(alpha=0.3, color="#e76f51") +
  #geom_text_repel(aes(label=iso3c), size=3, box.padding=0.01, point.padding = 0.01, label_padding=0.01, max.overlaps = 25 ) +
  geom_text(aes(label=iso3c), color="#264653",position=position_jitter(width=.2,height=.6), check_overlap=T) +
  theme_bw() +
  xlab('SPI PIllar 4 Score - Preferred') +
  ylab('SPI PIllar 4 Score - Alternative') +
  expand_limits(x=c(0,100), y=c(0,100)) +
  labs(title = "SPI Pillar 4 Scores in 2022 for Preferred and Alternative Indicator Weights",
       caption= str_wrap("Under the preferred approach, each indicator (censuses, surveys, administrative, and geospatial) receive weights of 1/4.  In the alternative version to follow, Pillar 4 is constructed so that 1/6 weight is given to censuses, 1/6 weight is given to surveys, 1/3 weight is given to administrative data, and 1/3 weight is given to geospatial data.", 110))

```


## Additional Findings by Pillar

The tables and charts below highlight differences across countries by income group in specific indicators.

```{r}

spi_income_table <- function(data, indicators, reference_year) {

      df_overall <- get(data) %>%
      filter(date==as.numeric(reference_year)) %>% 
      select(country, iso3c, date, income, region, all_of(indicators), SPI.INDEX) 
    
    
    spi_groups_quantiles <- quantile(df_overall$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)
    
    df_overall <- df_overall %>%
      mutate(spi_groups=case_when(
        between(SPI.INDEX, spi_groups_quantiles[4],100) ~ "Top Quintile",
        between(SPI.INDEX, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
        between(SPI.INDEX, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
        between(SPI.INDEX, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
        between(SPI.INDEX, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      )) %>%
      mutate(spi_groups=factor(spi_groups, 
                               levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
    
    #produce by income
    sumstats<- df_overall %>%
      group_by(income) %>%
      filter(income %in% c("Low income", "Lower middle income", "Upper middle income", "High income" )) %>%
      select(income, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    #produce global number
    sumstats_gl<- df_overall %>%
      mutate(income='Global') %>%
      group_by(income) %>%
      select(income, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    
    #transpose data
    sumstats_df_long <-sumstats 
    
    sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-income)))
    colnames(sumstats_df) = sumstats_df_long$income 
    
    
    sumstats_df <- sumstats_df %>%
      rownames_to_column() %>%
      rename(series=rowname)
    
    
    #create labels df
    metadata_tab2_overall <- metadata_full %>% 
      janitor::clean_names() %>%
      transmute(series=source_id, 
                indicator_name=source_name,
                pillar=pillar)
    
    
    #add variable label
    sumstats_df <- sumstats_df %>%
      left_join(metadata_tab2_overall) %>%
      rename(Pillar=pillar,
             Series=series,
             Label=indicator_name) %>%
      mutate(Label=if_else(is.na(Label),Series,Label)) %>%
      select(Pillar, Label, c("Low income", "Lower middle income", "Upper middle income", "High income" ))

      sumstats_df
 

}

FitFlextableToPage <- function(ft, pgwidth = 6){

  ft_out <- ft %>% 
    add_footer_lines(values = "SPI index scored on 0-100 scale.  Indicators scored on 0-1 scale. \n Source: World Bank. Statistical Performance Indicators."                 ) %>%
    autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

```

### Selected Indicators

**Table. Select SPI Indicators by Income Group in 2022 **
```{r sel}
indicators<-c("SPI.D1.5.DT.TDS.DPPF.XP.ZS","SPI.D2.2.Openness.subscore","SPI.D3.1.POV","SPI.D3.10.NEQL",
             "SPI.D4.1.1.POPU", "SPI.D4.2.3.CRVS", "SPI.D4.3.GEO.first.admin.level","SPI.D5.2.4.CPIBY", "SPI.D5.2.6.EMPL")

income_tab <- spi_income_table('spi_index_df',indicators,2022) 

tib <- as_grouped_data(x=income_tab, groups=c("Pillar"))

tib %>%
  as_flextable( ) %>% 
  flextable::compose(
    i = ~ !is.na(Pillar), # when var_group not NA
    j = "Label", # on column "var"
    # create a paragraph containing a chunk containing value of `var_group`
    value = as_paragraph(as_chunk(Pillar, props=officer::fp_text(bold=TRUE, color="#48cae4",font.size=12)))) %>% 
  hline(i = ~ !is.na(Pillar), border = officer::fp_border() ) %>% 
  autofit() %>%
  add_footer_lines(values = "SPI index scored on 0-100 scale.  Indicators scored on 0-1 scale. \n Source: World Bank. Statistical Performance Indicators."                 ) %>%
  fontsize(i=1,size=12, part='header') 


```


### Pillar 1: Data Use

**Table. Pillar 1: Data Use SPI Indicators by Income Group in 2022 **
```{r p1}

indicators<-c("SPI.D1.5.POV","SPI.D1.5.CHLD.MORT","SPI.D1.5.DT.TDS.DPPF.XP.ZS", "SPI.D1.5.SAFE.MAN.WATER", "SPI.D1.5.LFP")

income_tab <- spi_income_table('spi_index_df',indicators,2022) 

tib <- as_grouped_data(x=income_tab, groups=c("Pillar"))

tib %>%
  as_flextable( ) %>% 
  flextable::compose(
    i = ~ !is.na(Pillar), # when var_group not NA
    j = "Label", # on column "var"
    # create a paragraph containing a chunk containing value of `var_group`
    value = as_paragraph(as_chunk(Pillar, props=officer::fp_text(bold=TRUE, color="#48cae4",font.size=12)))) %>% 
  hline(i = ~ !is.na(Pillar), border = officer::fp_border() ) %>% 
  autofit() %>%
  add_footer_lines(values = "SPI index scored on 0-100 scale.  Indicators scored on 0-1 scale. \n Source: World Bank. Statistical Performance Indicators."                 ) %>%
  fontsize(i=1,size=12, part='header') 

```

### Pillar 2: Data Services

**Table. Pillar 2: Data Services SPI Indicators by Income Group in 2022 **
```{r p2}

indicators<-c("SPI.D2.1.GDDS",
              "SPI.D2.2.Openness.subscore",
              "SPI.D2.2.Machine.readable",      "SPI.D2.2.Non.proprietary",
              "SPI.D2.2.Download.options",      "SPI.D2.2.Metadata.available",
              "SPI.D2.2.Terms.of.use",
              "SPI.D2.4.NADA")

income_tab <- spi_income_table('spi_index_df',indicators,2022) 

tib <- as_grouped_data(x=income_tab, groups=c("Pillar"))

tib %>%
  as_flextable( ) %>% 
  flextable::compose(
    i = ~ !is.na(Pillar), # when var_group not NA
    j = "Label", # on column "var"
    # create a paragraph containing a chunk containing value of `var_group`
    value = as_paragraph(as_chunk(Pillar, props=officer::fp_text(bold=TRUE, color="#48cae4",font.size=12)))) %>% 
  hline(i = ~ !is.na(Pillar), border = officer::fp_border() ) %>% 
  autofit() %>%
  add_footer_lines(values = "SPI index scored on 0-100 scale.  Indicators scored on 0-1 scale. \n Source: World Bank. Statistical Performance Indicators."                 ) %>%
  fontsize(i=1,size=12, part='header') 

```

### Pillar 3: Data Products

**Table. Pillar 3: Data Products SPI Indicators by Income Group in 2022 **
```{r p3}

indicators<-c("SPI.D3.1.POV",
              "SPI.D3.2.HNGR",
              "SPI.D3.3.HLTH",
              "SPI.D3.4.EDUC",
              "SPI.D3.5.GEND",
              "SPI.D3.6.WTRS",
              "SPI.D3.7.ENRG",
              "SPI.D3.8.WORK",
              "SPI.D3.9.INDY",
              "SPI.D3.10.NEQL",
              "SPI.D3.11.CITY",
              "SPI.D3.12.CNSP",
              "SPI.D3.13.CLMT",
              "SPI.D3.15.LAND",
              "SPI.D3.16.INST",
              "SPI.D3.17.PTNS")

income_tab <- spi_income_table('spi_index_df',indicators,2022) 

tib <- as_grouped_data(x=income_tab, groups=c("Pillar"))

tib %>%
  as_flextable( ) %>% 
  flextable::compose(
    i = ~ !is.na(Pillar), # when var_group not NA
    j = "Label", # on column "var"
    # create a paragraph containing a chunk containing value of `var_group`
    value = as_paragraph(as_chunk(Pillar, props=officer::fp_text(bold=TRUE, color="#48cae4",font.size=12)))) %>% 
  hline(i = ~ !is.na(Pillar), border = officer::fp_border() ) %>% 
  autofit() %>%
  add_footer_lines(values = "SPI index scored on 0-100 scale.  Indicators scored on 0-1 scale. \n Source: World Bank. Statistical Performance Indicators."                 ) %>%
  fontsize(i=1,size=12, part='header') 

```

### Pillar 4: Data Sources

**Table. Pillar 4: Data Sources SPI Indicators by Income Group in 2022 **
```{r p4}

indicators<-c(
              "SPI.D4.1.1.POPU",
              "SPI.D4.1.2.AGRI",
              "SPI.D4.1.3.BIZZ",
              "SPI.D4.1.4.HOUS",
              "SPI.D4.1.5.AGSVY",
              "SPI.D4.1.6.LABR",
              "SPI.D4.1.7.HLTH",
              "SPI.D4.1.8.BZSVY",
              "SPI.D4.2.3.CRVS",
              "SPI.D4.3.GEO.first.admin.level")

income_tab <- spi_income_table('spi_index_df',indicators,2022) 

tib <- as_grouped_data(x=income_tab, groups=c("Pillar"))

tib %>%
  as_flextable( ) %>% 
  flextable::compose(
    i = ~ !is.na(Pillar), # when var_group not NA
    j = "Label", # on column "var"
    # create a paragraph containing a chunk containing value of `var_group`
    value = as_paragraph(as_chunk(Pillar, props=officer::fp_text(bold=TRUE, color="#48cae4",font.size=12)))) %>% 
  hline(i = ~ !is.na(Pillar), border = officer::fp_border() ) %>% 
  autofit() %>%
  add_footer_lines(values = "SPI index scored on 0-100 scale.  Indicators scored on 0-1 scale. \n Source: World Bank. Statistical Performance Indicators."                 ) %>%
  fontsize(i=1,size=12, part='header') 

```

### Pillar 5: Data Infrastructure

**Table. Pillar 5: Data Infrastructure SPI Indicators by Income Group in 2022 **
```{r p5}

indicators<-c(
              #"SPI.D5.1.DILG",
              "SPI.D5.2.1.SNAU",
              "SPI.D5.2.2.NABY",
              "SPI.D5.2.3.CNIN",
              "SPI.D5.2.4.CPIBY",
              "SPI.D5.2.5.HOUS",
              "SPI.D5.2.6.EMPL",
              "SPI.D5.2.7.CGOV",
              "SPI.D5.2.8.FINA",
              "SPI.D5.2.9.MONY",
              "SPI.D5.2.10.GSBP")
              #"SPI.D5.5.DIFI")

income_tab <- spi_income_table('spi_index_df',indicators,2022) 

tib <- as_grouped_data(x=income_tab, groups=c("Pillar"))

tib %>%
  as_flextable( ) %>% 
  flextable::compose(
    i = ~ !is.na(Pillar), # when var_group not NA
    j = "Label", # on column "var"
    # create a paragraph containing a chunk containing value of `var_group`
    value = as_paragraph(as_chunk(Pillar, props=officer::fp_text(bold=TRUE, color="#48cae4",font.size=12)))) %>% 
  hline(i = ~ !is.na(Pillar), border = officer::fp_border() ) %>% 
  autofit() %>%
  add_footer_lines(values = "SPI index scored on 0-100 scale.  Indicators scored on 0-1 scale. \n Source: World Bank. Statistical Performance Indicators."                 ) %>%
  fontsize(i=1,size=12, part='header') 
```

## Recency of Census

**Figure. Date of Most Recent Population and Housing Census by Fragile and Conflict Situation Status**
```{r, fig.width=15, fig.height=14}

    #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')

census_age_df <- spi_df_final %>%
  select(country, iso3c, date, income, region, SPI.D4.1.1.POPU, RAW.D4.1.1.POPU) %>%
  mutate(pop_census_age=as.numeric(str_extract(RAW.D4.1.1.POPU, "\\d{4}"))) %>%
  filter(date==2022) %>%
  mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"))
  
census_age_df <- census_age_df %>%
  group_by(pop_census_age) %>%
  mutate(country_len = row_number() )

ggplot(census_age_df, aes(x=pop_census_age, y=country_len, color=fcs)) +
  geom_text(aes(label=iso3c), size=4,position=position_jitter(width=.2,height=.6), check_overlap = TRUE) +
  theme_bw() +
  xlab('Year of Last Population Census') +
  ylab('Country') +
  expand_limits(x=c(1940:2025)) +
  theme(
    axis.title = element_text(size=18),
    axis.text = element_text(size=15),
    legend.text=element_text(size=15),
  
    legend.position = 'bottom'
  )

```

## Recency of National Account Base Year

**Figure. Date of National Account Base Year by Income**
```{r naby, fig.width=15, fig.height=14}

naby_age_df <- spi_df_final %>%
  select(country, iso3c, date, income, region, SPI.D5.2.2.NABY, RAW.D5.2.2.NABY) %>%
  mutate(naby_age=case_when(
    RAW.D5.2.2.NABY=="Original chained constant price data are rescaled." ~ 2022, 
    TRUE ~  as.numeric(RAW.D5.2.2.NABY))
  ) %>%
  filter(date==2022) %>%
  mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country")) %>%
  filter(country!="Puerto Rico") %>%
  filter(income!="Not classified")
  
naby_age_df <- naby_age_df %>%
  group_by(naby_age) %>%
  mutate(country_len = row_number() )

pal <- c("High income"= "#264653", "Upper middle income" = "#2a9d8f","Lower middle income"= "#f4a261","Low income"= "#e76f51")

ggplot(naby_age_df, aes(x=naby_age, y=country_len, color=income)) +
  geom_text(aes(label=iso3c), size=4,position=position_jitter(width=.2,height=.6), check_overlap = TRUE) +
  theme_bw() +
  xlab('Year of National Accounts Base Year') +
  ylab('Country') +
  scale_color_manual(
    values=pal
  ) +
  expand_limits(x=c(1980:2025)) +
  theme(
    axis.title = element_text(size=18),
    axis.text = element_text(size=15),
    legend.text=element_text(size=15),
    legend.position = 'bottom'
  )


```

# Estimating Relationship between Statistical Performance and Economic Growth

```{r regdf}
options(modelsummary_factory_word = 'flextable')
custom_theme <- function(x, ...) {
    x %>% set_table_properties(layout = "autofit")
}
options("modelsummary_theme_flextable" = custom_theme)


#get some potential predictors
# predictors_df <- WDI(
#   indicator = c('NV.IND.MANF.ZS', 'NV.AGR.TOTL.ZS','SE.SEC.CMPT.LO.ZS','NE.TRD.GNFS.ZS', 'CC.EST', "GE.EST", 'PV.EST', "RQ.EST", "RL.EST", "VA.EST"),
#   start=2015,
#   end=2022,
#   extra=TRUE
#   ) %>% 
#   dplyr::arrange(iso3c,-year) %>%
#   filter(region!="Aggregates") %>%
#   rename(date=year)

predictors_df <- wbstats::wb_data(country="countries_only",
             indicator=c('NY.GDP.PCAP.KD', 'NV.IND.MANF.ZS', 'NV.AGR.TOTL.ZS','NE.TRD.GNFS.ZS', 'HD.HCI.OVRL','SE.PRM.ENRR','BN.CAB.XOKA.GD.ZS', 'CC.EST', "GE.EST", 'PV.EST', "RQ.EST", "RL.EST", "VA.EST", "BX.KLT.DINV.WD.GD.ZS"),
             start_date=2010,
             end_date=2022) %>%
  mutate(date=as.numeric(date)) %>%
  arrange(iso3c, date) %>%
  group_by(iso3c) %>%
  fill(c( 'NY.GDP.PCAP.KD','NV.IND.MANF.ZS', 'NV.AGR.TOTL.ZS', 'SE.PRM.ENRR', 'HD.HCI.OVRL','NE.TRD.GNFS.ZS','BN.CAB.XOKA.GD.ZS', 'CC.EST', "GE.EST", 'PV.EST', "RQ.EST", "RL.EST", "VA.EST", "BX.KLT.DINV.WD.GD.ZS"), .direction="downup") %>%
  mutate(WGI.OVL=(CC.EST + GE.EST + PV.EST + RQ.EST + RL.EST + VA.EST)/6,
         lag_outcome=lag(NY.GDP.PCAP.KD),
         lag_fdi=lag(BX.KLT.DINV.WD.GD.ZS),
         lag_ge=lag(GE.EST)
         )  %>%
  ungroup()


#get central government debt data from IMF which is more complete source
imf_dta <- haven::read_dta("C:/Users/wb469649/OneDrive - WBG/DECIS/SPI/Blog - SPI and Bond Spreads/01_Data/Global Debt Database_121521_to_DATAMAPPER.dta" ) %>% 
  rename(imf_code=ifscode,
         date=year) %>%
  left_join(read_csv(file="C:/Users/wb469649/Documents/Github/Gender-SPI/01_raw_data/metadata/IMF_country_codes.csv")) %>%
  select(iso3c, date, cg)

# predictors_df <- predictors_df %>%
#   left_join(imf_dta)

SPI_2016 <- SPI %>%
  filter(date>=2016) %>%
  group_by(iso3c) %>%
  fill(starts_with( 'SPI.INDEX'), .direction="downup") %>%
  ungroup() %>%
  filter(!is.na(SPI.INDEX))

countries_2016 <- unique(SPI_2016$country)

#add in some metadata about the country
reg_df <- SPI_2016 %>%
  select(country, iso3c, date, region, SPI.INDEX, SPI.INDEX.PIL1, SPI.INDEX.PIL2, SPI.INDEX.PIL3, SPI.INDEX.PIL4, SPI.INDEX.PIL5) %>%
  left_join(predictors_df) %>%
  filter(between(date,2016,2022)) %>%
  filter(!(is.na(SPI.INDEX) | 
             is.na(NY.GDP.PCAP.KD) |
             is.na(NV.IND.MANF.ZS) |
             is.na(NV.AGR.TOTL.ZS) |
             is.na(SE.PRM.ENRR) |
             is.na(NE.TRD.GNFS.ZS) |
             #is.na(cg) | 
             #is.na(BN.CAB.XOKA.GD.ZS) |
             is.na(CC.EST) |
             is.na(GE.EST) |
             is.na(PV.EST) |
             is.na(RQ.EST) |
             is.na(RL.EST) |
             is.na(VA.EST) )) %>%
  mutate(region_year_fe=paste(region,date,sep=" - "))

ncountry <- length(unique(reg_df$country))

#use modelsumary to predict
#modelsummary output
gm <- tibble::tribble(
  ~raw,        ~clean,          ~fmt,
  "nobs",      "N",             0,
  "r.squared", "R Sq.", 2)


cross_reg_df <- reg_df %>%
  arrange(country) %>%
  group_by(country, iso3c) %>%
  summarise(growth=log(first(NY.GDP.PCAP.KD))-log(last(NY.GDP.PCAP.KD)),
            across(c('SPI.INDEX','NY.GDP.PCAP.KD','NV.IND.MANF.ZS', 'NV.AGR.TOTL.ZS','NE.TRD.GNFS.ZS','SE.PRM.ENRR', 'HD.HCI.OVRL','BN.CAB.XOKA.GD.ZS', 'CC.EST', "GE.EST", 'PV.EST', "RQ.EST", "RL.EST", "VA.EST",  "WGI.OVL",'region'),~last(.))
            
            )



#create regression models
 models <- list(


 'Dynamic Model (Year FE)' = feols(log(NY.GDP.PCAP.KD) ~  log(lag_outcome) + SPI.INDEX + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS + SE.PRM.ENRR  + NE.TRD.GNFS.ZS + WGI.OVL | date   , data=reg_df, se='cluster', cluster='country') ,

 'Dynamic Model (Year FE)' = feols(log(NY.GDP.PCAP.KD) ~  log(lag_outcome) +  SPI.INDEX.PIL1 + SPI.INDEX.PIL2 + SPI.INDEX.PIL3 + SPI.INDEX.PIL4 + SPI.INDEX.PIL5 + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS + SE.PRM.ENRR  + NE.TRD.GNFS.ZS + WGI.OVL  | date  , data=reg_df, se='cluster', cluster='country') ,
   
   
 # 'Longitudinal Model (Year FE)' = feols(log(NY.GDP.PCAP.KD) ~  SPI.INDEX + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS + SE.PRM.ENRR  + NE.TRD.GNFS.ZS + WGI.OVL | date, data=reg_df, se='cluster', cluster='country') ,
 # 
 # 'Longitudinal Model (Year FE)' = feols(log(NY.GDP.PCAP.KD) ~  SPI.INDEX.PIL1 + SPI.INDEX.PIL2 + SPI.INDEX.PIL3 + SPI.INDEX.PIL4 + SPI.INDEX.PIL5 + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS + SE.PRM.ENRR  + NE.TRD.GNFS.ZS + WGI.OVL | date , data=reg_df, se='cluster', cluster='country') ,

  # 'Longitudinal Model (Country RE/Year FE)' = plm::plm(log(NY.GDP.PCAP.KD) ~  SPI.INDEX +  NV.IND.MANF.ZS + NV.AGR.TOTL.ZS + SE.PRM.ENRR  + NE.TRD.GNFS.ZS + WGI.OVL  + factor(date), data=reg_df, model='random', index=c('iso3c')) ,
 

 'Longitudinal Model (Country FE/Year FE)' = feols(log(NY.GDP.PCAP.KD) ~  SPI.INDEX + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS +  SE.PRM.ENRR  + NE.TRD.GNFS.ZS + WGI.OVL | country+date , data=reg_df, se='cluster', cluster='country'),
 
 'Longitudinal Model (Country FE/Year FE)' = feols(log(NY.GDP.PCAP.KD) ~  SPI.INDEX.PIL1 + SPI.INDEX.PIL2 + SPI.INDEX.PIL3 + SPI.INDEX.PIL4 + SPI.INDEX.PIL5 + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS +  SE.PRM.ENRR  + NE.TRD.GNFS.ZS + WGI.OVL | country+date , data=reg_df, se='cluster', cluster='country')
 

 )



```

```{r eval=FALSE, include=FALSE}
# test between fixed and random effects estiamtes

fixed <- plm::plm(log(NY.GDP.PCAP.KD) ~   SPI.INDEX + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS + SE.PRM.ENRR  + BN.CAB.XOKA.GD.ZS + WGI.OVL  , data=reg_df, model='within', index=c('iso3c'), effect='twoways')

summary(fixed)

random <- plm::plm(log(NY.GDP.PCAP.KD) ~   SPI.INDEX + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS + SE.PRM.ENRR  + BN.CAB.XOKA.GD.ZS + WGI.OVL  , data=reg_df, model='random', index=c('iso3c'))

summary(random)



plm::phtest(fixed, random, method="aux", vcov=function(x) vcovHC(x, method="white2", type="HC3"))

```

In this analysis, the relationship between statistical performance and economic growth and other intermediate indicators of economic growth will be examined using a two alternative econometric model. The sample consists of `r ncountry` countries, which have a non-missing data with a time span between 2016 and 2022.^[`r length(countries_2016)` countries have a non-missing SPI score in 2016.  The binding constraint keeping most countries from having an SPI score in 2016 is the availability of data from the Open Data Inventory (ODIN), produced by Open Data Watch, which was used for the SPI measures of data openness and geospatial information. The remainder of countries omitted lack either a human capital index score or some cases trade data.]  

The first econometric model is a dynamic linear model where GDP per capita follows a random walk and a structural component made up of the SPI score and other covariates. The linear model includes the lag of log GDP per capita as a control as well as the SPI and other control variables.  To account for global macroeocnomic fluctuations, the model also includes a dummy variable for the year. In the tables, this model is referred to as the "Dynamic Model".  The specification is:

$$ GDPpc_{i,t} = \alpha + \gamma GDPpc_{i,(t-1)}+ \beta_1 SPI_{i,t}  + \beta2 MFG_{i,t} + \beta_3 AG_{i,t} + \beta_4 Sch_{i,t} + \beta_5 Trade_{i,t} + \beta_6 PolInst_{i,t} + \tau_t+ \epsilon_{i,t} $$

where $GDPpc_{i,t}$ is the log of GDP per capita based on 2015 constant US dollars for country $c$ in year $t$.  $SPI_{i,t}$ is the value of the SPI overall score in year $t$.  $GDPpc_{i,(t-1)}$ is the level of GDP per capita in the previous year.  $MFG_{i,16}$ and $AG_{i,16}$ are manufacturing value added and agricultural, forestry, and fishing value added as a percentage of GDP, which are measures of the sectoral composition of the economy.  $Sch_{i,t}$ is the school enrollment, primary (% gross) for the country in year t.  $Trade_{i,16}$ is the level of trade (exports + imports) as a percentage of GDP in year $t$.  Finally, $PolInst_{i,t}$ is an index of political institutions as measured by the [World Governance Indicators (WGI)](http://info.worldbank.org/governance/wgi/).  This is specified as the average of the WGI scores related to control of corruption, governance effectiveness, political stability and absence of violence/terrorism, regulatory quality, rule of law, and voice and accountability. $\tau_t$ is a year dummy variable.  $\epsilon_{i,t}$ is an idiosyncratic error term.

The second model is a longitudinal model that will be estimated using a panel fixed effect estimator with country fixed effects and year fixed effects.  This model is named the "Longitudinal Model" in the tables below.

$$ GDPpc_{i,t} = \alpha + \beta_1 SPI_{i,t}  + \beta2 MFG_{i,t} + \beta_3 AG_{i,t} + \beta_4 HCI_{i,t} + \beta_5 Trade_{i,t} + \beta_6 PolInst_{i,t} + c_{i} + \tau_{t} + \epsilon_{i,t} $$

In this case, $GPDpc_{i,(t-1)}$, the log lagged GDP per capita for country i in year t is dropped from the model.  $c_{i}$ representing the unobserved effect for country $i$ is included in the model, which accounts for time constant factors affecting GDP per capita in a specific country.

An additional variant within each model is included as well, where the $SPI_{i,t}$ variable is split into the scores for each of the five SPI pillars (data use, data services, data products, data sources, and data infrastructure).  This specification allows the examination of which specific pillar may be driving changes in GDP per capita.

Results from estimating the models is below.  The "Dynamic Model" is estimated via OLS.  The "Longitudinal Model" is estimated using the panel fixed effects estimator (also known as the "within estimator") as discussed in Wooldridge (2010).  

In column (1) of the table which show estimates from the "Dynamic model", the results indicate that a one unit (scale 0-100) on the SPI overall score increases GDP per capita by 0.1%.  This is statistically significant at  the 1% level.  To give some perspective, the median country grew 5.5 points on the SPI overall score between 2016 and 2022.  The 75th percentile country grew 9.7 points and the 90th percentile country grew 13.3 points on the SPI scale.  A country that grew at the 75th percentile then would have seen GDP per capita grow by nearly 1% according to these estimates.  In column (2) which breaks down the impacts into the underlying SPI pillar effects, shows a statistically significant (1% level), but small effect of Pillar 5 on data infrastructure of 0.03%.  None of the other SPI pillars have detectable effects on GDP per capita.

In column (3), the "Longitudinal Model" estimates indicate no statistically significant impact of the SPI overall score on GDP per capita, although the sign and magnitude is similar as in the dynamic model.  Column (4) indicates that the SPI Pillar 5 score on data infrastructure has a statistically significant effect (at 1% level) on GDP per capita.  

One potential explanation of the statistically significant impact of the SPI Pillar 5 score on data infrastructure is that the data infrastructure indicators measure the recency of the national accounts base year and the system of national accounts (for instance SNA 2008 or older).  Improvements in the accounting of national accounts could lead to upward revisions in GDP for a country and a positive effect of these improvements on log GDP per capita.

Table. Relationship between Log GDP per capita and SPI scores using data from 2016-2022.

```{r}
 modelsummary(models,
              estimate= "{estimate}{stars}",
              #vcov=list(NULL,"HC1",NULL),
              coef_rename = c("SPI.INDEX"  = "SPI Overall Score",
                              "SPI.INDEX.PIL1"  = "SPI Pillar 1 Score",
                              "SPI.INDEX.PIL2"  = "SPI Pillar 2 Score",
                              "SPI.INDEX.PIL3"  = "SPI Pillar 3 Score",
                              "SPI.INDEX.PIL4"  = "SPI Pillar 4 Score",
                              "SPI.INDEX.PIL5"  = "SPI Pillar 5 Score",
                              "log(lag_outcome)" = "Log lagged GDP per capita" ,
                              "NV.IND.MANF.ZS"  = "Manufacturing value added (% of GDP)",
                              "NV.AGR.TOTL.ZS"= "Agriculture, forestry, fishing value added (% of GDP)",
                              "BN.CAB.XOKA.GD.ZS"= "Current account balance (% of GDP)",
                              "HD.HCI.OVRL" = "Human Capital Index (0-1 scale)",
                              "SE.PRM.ENRR" = "School Enrollment, Primary (% gross)" ,
                              "NE.TRD.GNFS.ZS" = "Trade (% of GDP)",
                              "WGI.OVL" = "WGI Index",
                              "CC.EST" = "WGI: Control of Corruption: Estimate",
                              "GE.EST" = "WGI: Governance Effectiveness: Estimate",
                              "PV.EST" = "WGI: Political Stability and Absence of Violence/Terrorism: Estimate",
                              "RQ.EST" = "WGI: Regulatory Quality: Estimate",
                              "RL.EST" = "WGI: Rule of Law: Estimate",
                              "VA.EST" = "WGI: Voice and Accountability: Estimate"),
              gof_map = gm,
              notes="Data from the World Bank's World Development Indicators (WDI) and SPI.  WDI series codes include NY.GDP.MKTP.KD.ZG, NV.IND.MANF.ZS, NV.AGR.TOTL.ZS,SE.PRM.ENRR,BN.CAB.XOKA.GD.ZS, CC.EST, GE.EST, PV.EST, RQ.EST, RL.EST, VA.EST.  Data for year 2016-2022.  Data accessed on March 15, 2022.  Dynamic model includes lagged outcome in model.  Longitudinal model controls for country fixed effects.  In cases where data is missing for a particular covariate, the data is imputed using the nearest available value. Standard errors clustered at the country level.
              ***=0.001 level
              **=0.01 level
              *=0.05 level
              +=0.1 level",
              escape = FALSE
              )
```


## Intermediate Impacts on the economy

In addition to looking at the impact of improvements in statistical performance on GDP per capita, two additional impacts are considered: improvements in government effectiveness according to the WGI and reductions in dollar denominated government bond spreads.^[ A version of the bond spreads analysis was first published in a World Bank blog post(https://blogs.worldbank.org/opendata/not-all-data-are-created-equal-why-adoption-international-data-standards-pays) by Lucas Kitzmueller, Brian Stacy, Daniel Mahler, and Umar Serajuddin on September 1, 2021.]  A very similar econometric model is used for these two additional outcomes: a dynamic model and a longitudinal model with country fixed effects.


In the case of government effectiveness, the lag of government effectiveness is included in the dynamic model (rather than log lagged GDP per capita). Additionally, the sectoral composition (manufacturing and agriculture) and trade control variables are excluded from the analysis as there is no clear theoretical reason for why these controls should affect governement effectiveness.  Government effectiveness is measured using the World Governance Indicators.

In the table below, there is no detectable relationship between the SPI overall score and government effectiveness in the dynamic or longitudinal models.  However, the SPI pillar 2 score on data services and openness has a statistically significant impact at the 5% level in the dynamic model, with a similar sign and magnitude but insignificant in the longitudinal model.  A ten unit improvement in data services is associated with an improvement of .01 standard deviations of government effectiveness.  The SPI pillar 3 scores on data sources is statistically significant at the 1% level in the longitudinal model suggesting a 10 point improvement in data products, measuring the availability of SDG indicators for the country, is associated with a .04 standard deviation improvement in government effectiveness.  One interpretation is that additional access (pillar 2) and availability (pillar 3) of data for the country improves government effectiveness.

Table. Relationship between Government Effectiveness and SPI scores using data from 2016-2022.

```{r}

cross_reg_ge_df <- reg_df %>%
  arrange(country) %>%
  group_by(country, iso3c) %>%
  summarise(init_ge=last(GE.EST),
            GE.EST=first(GE.EST),
            across(c('SPI.INDEX','NY.GDP.PCAP.KD','NV.IND.MANF.ZS', 'NV.AGR.TOTL.ZS','NE.TRD.GNFS.ZS','SE.PRM.ENRR', 'HD.HCI.OVRL','BN.CAB.XOKA.GD.ZS', 'CC.EST', 'PV.EST', "RQ.EST", "RL.EST", "VA.EST", "WGI.OVL",'region'),~last(.))
            
            )

reg_ge_df <- reg_df %>%
  arrange(iso3c,date) %>%
  group_by(iso3c) %>%
  mutate(growth=GE.EST-lag(GE.EST)) 

#create regression models
 GE_models <- list(


  'Dynamic Model (Year FE)' = feols(GE.EST ~  lag_ge + SPI.INDEX + SE.PRM.ENRR | date   , data=reg_df, se='cluster', cluster='country') ,

 'Dynamic Model (Year FE)' = feols(GE.EST ~  lag_ge +  SPI.INDEX.PIL1 + SPI.INDEX.PIL2 + SPI.INDEX.PIL3 + SPI.INDEX.PIL4 + SPI.INDEX.PIL5 + SE.PRM.ENRR  | date  , data=reg_df, se='cluster', cluster='country') ,
 

 'Longitudinal Model (Country FE/Year FE)' = feols(GE.EST ~  SPI.INDEX +  SE.PRM.ENRR   | country+date , data=reg_df) ,
 
  'Longitudinal Model (Country FE/Year FE)' = feols(GE.EST ~  SPI.INDEX.PIL1 + SPI.INDEX.PIL2 + SPI.INDEX.PIL3 + SPI.INDEX.PIL4 + SPI.INDEX.PIL5 +  SE.PRM.ENRR   | country+date , data=reg_df) 

 )


 modelsummary(GE_models,
              estimate= "{estimate}{stars}",
              #vcov=list(NULL,"stata",NULL),
              coef_rename = c("SPI.INDEX"  = "SPI Overall Score",
                              "SPI.INDEX.PIL1"  = "SPI Pillar 1 Score",
                              "SPI.INDEX.PIL2"  = "SPI Pillar 2 Score",
                              "SPI.INDEX.PIL3"  = "SPI Pillar 3 Score",
                              "SPI.INDEX.PIL4"  = "SPI Pillar 4 Score",
                              "SPI.INDEX.PIL5"  = "SPI Pillar 5 Score",
                              "lag_ge" = "lagged Government Effectiveness" ,
                              "NV.IND.MANF.ZS"  = "Manufacturing value added (% of GDP)",
                              "NV.AGR.TOTL.ZS"= "Agriculture, forestry, fishing value added (% of GDP)",
                              "BX.KLT.DINV.WD.GD.ZS"= "Foreign direct investment, net inflows (% of GDP)",
                              "SE.PRM.ENRR" = "School Enrollment, Primary (% gross)" ,
                              "NE.TRD.GNFS.ZS" = "Trade (% of GDP)",
                              "CC.EST" = "WGI: Control of Corruption: Estimate",
                              "GE.EST" = "WGI: Governance Effectiveness: Estimate",
                              "PV.EST" = "WGI: Political Stability and Absence of Violence/Terrorism: Estimate",
                              "RQ.EST" = "WGI: Regulatory Quality: Estimate",
                              "RL.EST" = "WGI: Rule of Law: Estimate",
                              "VA.EST" = "WGI: Voice and Accountability: Estimate"),
              gof_map = gm,
              notes="Data from the World Bank's World Development Indicators (WDI) and SPI.  WDI series codes include BX.KLT.DINV.WD.GD.ZS, NV.IND.MANF.ZS, NV.AGR.TOTL.ZS,SE.PRM.ENRR,BN.CAB.XOKA.GD.ZS, CC.EST, GE.EST, PV.EST, RQ.EST, RL.EST, VA.EST.  Data for year 2016-2022.  Data accessed on March 15, 2022.  Dynamic model includes lagged outcome in model.  Longitudinal model controls for country fixed effects.  In cases where data is missing for a particular covariate, the data is imputed using the nearest available value. Standard errors clustered at the country level.
              ***=0.001 level
              **=0.01 level
              *=0.05 level
              +=0.1 level",
              escape = FALSE
              )
```



```{r bonddata}
# Bonds

# Load data

sp <- readxl::read_excel("C:/Users/wb469649/OneDrive - WBG/DECIS/SPI/Blog - SPI and Bond Spreads/01_Data/LIB127603_govt bond spreads_final.xlsx", 
                 sheet = "batch1")
# data are 10 year govt bonds, yield to maturity, with us govt bonds as benchmark

# This reshaping is a bit unconventional but does the job. The problem is that the date varies across columns, and therefore we can't use "normal" pivot_longer() or gather()

sp_dates <- pivot_longer(select(sp, contains("date")), contains("date"), names_to = "name_date", values_to = "date")
sp_dates$ID <- seq.int(nrow(sp_dates))

sp_values <- pivot_longer(select(sp, contains("value")), contains("value"))
sp_values$ID <- seq.int(nrow(sp_dates))

df <-  left_join(sp_dates, sp_values)

# Clean up df
df$name <- substr(df$name,1,3)
df <- df %>% select(-c(ID, name_date))
df <- df %>% rename(iso3c =  name)
df <- df %>% rename(spread =  value)
df<-df[!(df$iso3c=="VEN"),] # remove venezuela
df<-df[!(df$iso3c=="ARG"),] # and argentina as huge outliers

#usa$date <- axis.Date(1, as.Date(usa$date, origin = "1970-01-01"))

# Extract year from date variable and summarize by year
df$year <- format(df$date, format = "%Y")
df <- select(df,-c("date"))

# Add USA (by definition, spread of 0)
usa<-tibble(year = c(2021,2020,2019,2018,2017,2016,2015),
            iso3c = rep("USA",7),
            spread = rep(0,7))
df <- rbind(df, usa)

# Summarize by year
bond_spread_summary_df <- df %>%
  group_by(year, iso3c) %>%
  summarise(spread = mean(spread, na.rm = TRUE)) %>%
  arrange(iso3c, year) %>%
  group_by(iso3c) %>%
  mutate(lag_spread=lag(spread)) %>%
  ungroup()

bond_spread_summary_df$date <- as.numeric(bond_spread_summary_df$year)


#get relevant data from WDI
# select relevant series and years
relevant_series = c("GC.DOD.TOTL.GD.ZS", "BN.CAB.XOKA.GD.ZS", "NY.GDP.MKTP.KD.ZG", "NY.GDP.PCAP.KD", "NE.TRD.GNFS.ZS", "FP.CPI.TOTL.ZG", "DT.DOD.DECT.GN.ZS")

bond_control_df <- wbstats::wb_data(country="countries_only",
             indicator=relevant_series,
             start_date=2010,
             end_date=2022) %>%
  mutate(date=as.numeric(date)) %>%
  group_by(iso3c) %>%
  fill(relevant_series, .direction="downup") %>%
  ungroup() 


bond_control_df <- bond_control_df %>%
  left_join(imf_dta)

bond_spread_reg_df <- SPI_2016 %>%
  select(country, iso3c, date, region, starts_with('SPI.INDEX')) %>%
  left_join(bond_control_df) %>%
  left_join(bond_spread_summary_df) %>%
  filter(!(is.na(spread) | is.na(SPI.INDEX)  | 
             is.na(BN.CAB.XOKA.GD.ZS) |
             is.na(NY.GDP.MKTP.KD.ZG) |
             is.na(NY.GDP.PCAP.KD) |
             is.na(NE.TRD.GNFS.ZS) |
             is.na(FP.CPI.TOTL.ZG) |
             is.na(cg)  ))

country_num_bonds <- length(unique(bond_spread_reg_df$country))

country_list_bonds <- paste(unique(bond_spread_reg_df$country), collapse = ", ")

```
An analysis of the impacts of improvements on the SPI on 10 year dollar denominated government bond spreads is below.  The 10 year dollar denominated government bond spreads measure the additional costs of borrowing money for a country relative to the U.S.A.  The regression model includes the level of GDP per capita, the GDP growth rate, trade as a percentage of GDP, the current account balance as a percentage of GDP, and the central government total debt as a percentage of GDP as a control.  

The data on 10 year dollar denominated government bond spreads was collected from Bloomberg from the period 2015 to 2022 for `r country_num_bonds`.^[The countries where bond spreads were collected includes `r country_list_bonds`.]

The dynamic model in column (1) indicates that an improvement of 10 points on the SPI overall score is associated with a reduction in bond spreads of roughly 37 basis points, which would be equivalent to a reduction of interest rates of .37 percentage points.  Column (2) indicates that this is driven by the improvements in data infrastructure (pillar 5), which indicate that a 10 point improvement in data infrastructure is associated with a reduction of around 16 basis points in bond spreads.  Data infrastructure includes several indicators on whether for instance the country uses the latest system of national accounts, system of classifying monetary and financial statistics, system of government finance statistics, and system of central government accounting, and has a recent CPI base year.

The estimates from the longitudinal model are highly imprecise in column (3) and (4), so no clear relationships can be identified.

Table. Relationship between Dollar Denominated Government Bond Spreads and SPI scores using data from 2016-2022.

```{r}





bond_models <- list(

  
  'Dynamic Model (Year FE)' = feols(spread ~  lag_spread  + SPI.INDEX  + BN.CAB.XOKA.GD.ZS + NY.GDP.MKTP.KD.ZG + NY.GDP.PCAP.KD + NE.TRD.GNFS.ZS + FP.CPI.TOTL.ZG + cg | date   , data=bond_spread_reg_df, se='cluster', cluster='country') ,

 'Dynamic Model (Year FE)' = feols(spread ~  lag_spread  + SPI.INDEX.PIL1 + SPI.INDEX.PIL2 + SPI.INDEX.PIL3 + SPI.INDEX.PIL4 + SPI.INDEX.PIL5  + BN.CAB.XOKA.GD.ZS + NY.GDP.MKTP.KD.ZG + NY.GDP.PCAP.KD + NE.TRD.GNFS.ZS + FP.CPI.TOTL.ZG + cg  | date  , data=bond_spread_reg_df, se='cluster', cluster='country') ,
 
    'Longitudinal Model (Country FE/Year FE)' = feols(spread ~  SPI.INDEX  + BN.CAB.XOKA.GD.ZS + NY.GDP.MKTP.KD.ZG + NY.GDP.PCAP.KD + NE.TRD.GNFS.ZS + FP.CPI.TOTL.ZG + cg | country+date , data=bond_spread_reg_df, se='cluster', cluster='country'), 
 
     'Longitudinal Model (Country FE/Year FE)' = feols(spread ~   SPI.INDEX.PIL1 + SPI.INDEX.PIL2 + SPI.INDEX.PIL3 + SPI.INDEX.PIL4 + SPI.INDEX.PIL5  + BN.CAB.XOKA.GD.ZS + NY.GDP.MKTP.KD.ZG + NY.GDP.PCAP.KD + NE.TRD.GNFS.ZS + FP.CPI.TOTL.ZG + cg | country+date , data=bond_spread_reg_df, se='cluster', cluster='country')

 )


 modelsummary(bond_models,
              estimate= "{estimate}{stars}",
              coef_rename = c("SPI.INDEX"  = "SPI Overall Score",
                              "SPI.INDEX.PIL1"  = "SPI Pillar 1 Score",
                              "SPI.INDEX.PIL2"  = "SPI Pillar 2 Score",
                              "SPI.INDEX.PIL3"  = "SPI Pillar 3 Score",
                              "SPI.INDEX.PIL4"  = "SPI Pillar 4 Score",
                              "SPI.INDEX.PIL5"  = "SPI Pillar 5 Score",
                              "lag_spread" = "lagged Bond Spread" ,
                              "cg"  = "Central government debt, total (% of GDP)",
                              "BN.CAB.XOKA.GD.ZS"= "Current account balance (% of GDP)",
                              "NY.GDP.MKTP.KD.ZG"= "GDP per capita (constant 2015 US$)",
                              "NY.GDP.PCAP.KD" = "GDP growth (annual %)" ,
                              "NE.TRD.GNFS.ZS" = "Trade (% of GDP)",
                              "FP.CPI.TOTL.ZG" = "Inflation, consumer prices (annual %)",
                              "DT.DOD.DECT.GN.ZS" = "External debt stocks (% of GNI)"),
              gof_map = gm,
              notes="Data from the World Bank's World Development Indicators (WDI) and SPI.  WDI series codes include BN.CAB.XOKA.GD.ZS, NY.GDP.MKTP.KD.ZG, NY.GDP.PCAP.KD,SE.PRM.ENRR,NE.TRD.GNFS.ZS, NE.TRD.GNFS.ZS, FP.CPI.TOTL.ZG.  Central government debt data came from IMF.  Data for year 2016-2022.  Data accessed on March 15, 2022.  In cases where data is missing for a particular covariate, the data is imputed using the nearest available value.",
              escape = FALSE
              )

```

The results from this regression analysis indicate improving statistical performance can have impacts on the macroeconmy of a country and the country's government effectiveness.  Improvements of 10 points on the SPI overall score, which would be near the performance of the 75th percentile country between 2016 and 2022,has an impact in the range of 0-1% on GDP per capita depending on the model.  It is associated with a 37 basis point improvement in government bond spreads in one model.  Finally, the underlying pillars of the SPI are associated with multiple outcomes.  A 10 unit increase in the SPI data infrastructure score (pillar 5) is associated with a statistically significant 0-1% improvement in GDP per capita and a 16 basis point reduction in bond spreads.  A 10 unit increase in data services, including openness, (pillar 2) is associated with a .01 standard deviation improvement in government effectiveness according to the WGI, and a 10 unit increase in data products, or the availability of SDG indicators, is assocaited with a .04 standard deviation improvement in government effectiveness.



```{r eval=FALSE, include=FALSE}
#create regression models

cross_reg_fdi_df <- reg_df %>%
  arrange(country) %>%
  group_by(country, iso3c) %>%
  summarise(growth=first(BX.KLT.DINV.WD.GD.ZS)-last(BX.KLT.DINV.WD.GD.ZS),
            across(c('SPI.INDEX','NY.GDP.PCAP.KD','NV.IND.MANF.ZS', 'NV.AGR.TOTL.ZS','NE.TRD.GNFS.ZS','SE.PRM.ENRR', 'HD.HCI.OVRL','BN.CAB.XOKA.GD.ZS', 'CC.EST', "GE.EST", 'PV.EST', "RQ.EST", "RL.EST", "VA.EST", "WGI.OVL",'region'),~last(.))
            
            )

 bond_models <- list(


 'Dynamic Model (Year FE)' = feols(BX.KLT.DINV.WD.GD.ZS ~  lag_fdi + SPI.INDEX + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS + SE.PRM.ENRR  + NE.TRD.GNFS.ZS + WGI.OVL | date   , data=reg_df, se='cluster', cluster='country') ,

 'Dynamic Model (Year FE)' = feols(BX.KLT.DINV.WD.GD.ZS ~  lag_fdi +  SPI.INDEX.PIL1 + SPI.INDEX.PIL2 + SPI.INDEX.PIL3 + SPI.INDEX.PIL4 + SPI.INDEX.PIL5 + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS + SE.PRM.ENRR  + NE.TRD.GNFS.ZS + WGI.OVL  | date  , data=reg_df, se='cluster', cluster='country') ,

 'Longitudinal Model (Country FE/Year FE)' = feols(BX.KLT.DINV.WD.GD.ZS ~  SPI.INDEX + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS + SE.PRM.ENRR  + NE.TRD.GNFS.ZS + WGI.OVL | country+date , data=reg_df, se='cluster', cluster='country'),
 
 'Longitudinal Model (Country FE/Year FE)' = feols(BX.KLT.DINV.WD.GD.ZS ~  SPI.INDEX.PIL1 + SPI.INDEX.PIL2 + SPI.INDEX.PIL3 + SPI.INDEX.PIL4 + SPI.INDEX.PIL5 + NV.IND.MANF.ZS + NV.AGR.TOTL.ZS + SE.PRM.ENRR  + NE.TRD.GNFS.ZS + WGI.OVL | country+date , data=reg_df, se='cluster', cluster='country') 

 )


 modelsummary(bond_models,
              estimate= "{estimate}{stars}",
              #vcov=list(NULL,"HC1",NULL),
              coef_rename = c("SPI.INDEX"  = "SPI Overall Score",
                              "SPI.INDEX.PIL1"  = "SPI Pillar 1 Score",
                              "SPI.INDEX.PIL2"  = "SPI Pillar 2 Score",
                              "SPI.INDEX.PIL3"  = "SPI Pillar 3 Score",
                              "SPI.INDEX.PIL4"  = "SPI Pillar 4 Score",
                              "SPI.INDEX.PIL5"  = "SPI Pillar 5 Score",
                              "lag_fdi" = "lagged FDI" ,
                              "NV.IND.MANF.ZS"  = "Manufacturing value added (% of GDP)",
                              "NV.AGR.TOTL.ZS"= "Agriculture, forestry, fishing value added (% of GDP)",
                              "BN.CAB.XOKA.GD.ZS"= "Current account balance (% of GDP)",
                              "HD.HCI.OVRL" = "Human Capital Index (0-1 scale)",
                              "SE.PRM.ENRR" = "School Enrollment, Primary (% gross)" ,
                              "NE.TRD.GNFS.ZS" = "Trade (% of GDP)",
                              "WGI.OVL" = "WGI Index",
                              "CC.EST" = "WGI: Control of Corruption: Estimate",
                              "GE.EST" = "WGI: Governance Effectiveness: Estimate",
                              "PV.EST" = "WGI: Political Stability and Absence of Violence/Terrorism: Estimate",
                              "RQ.EST" = "WGI: Regulatory Quality: Estimate",
                              "RL.EST" = "WGI: Rule of Law: Estimate",
                              "VA.EST" = "WGI: Voice and Accountability: Estimate"),
              gof_map = gm,
              notes="Data from the World Bank's World Development Indicators (WDI) and SPI.  WDI series codes include BX.KLT.DINV.WD.GD.ZS, NV.IND.MANF.ZS, NV.AGR.TOTL.ZS,SE.PRM.ENRR,BN.CAB.XOKA.GD.ZS, CC.EST, GE.EST, PV.EST, RQ.EST, RL.EST, VA.EST.  Data for year 2016-2022.  Data accessed on March 15, 2022.  Dynamic model includes lagged outcome in model.  Longitudinal model controls for country fixed effects.  In cases where data is missing for a particular covariate, the data is imputed using the nearest available value. Standard errors clustered at the country level.
              ***=0.001 level
              **=0.01 level
              *=0.05 level
              +=0.1 level",
              escape = FALSE
              )
```