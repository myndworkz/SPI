---
title: '2023 SPI Update: What is New?'
author: "Prepared by Umar Serajuddin & Brian Stacy"
date: "`r Sys.Date()`"
date-format: long
output:
  bookdown::word_document2: 
    fig_width: 9
    fig_height: 6
    number_sections: false
abstract: 'In 2023, the second vintage of the Statistical Performance Indicator (SPI) data was released. In this new edition, SPI scores for the calendar year 2020, 2021, and 2022 have been released. There were no changes to the framework, methodology, or data sources for the SPI compared to previous releases.  This document provides an overview of the major changes to the scores compared to the intial data release in March 2021, which contained data up to 2019.'
bibliography: ./bibliography.bib
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9.5, fig.height = 6, fig.path = "plots/", dev = c("png"), dpi=500)


library(tidyverse)
library(flextable)
library(here)
# devtools::install_github("worldbank/wbgviz", subdir = "wbgcharts")
# devtools::install_github("worldbank/wbgviz", subdir = "wbggeo")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgmaps")
# library(wbggeo)
# library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(haven)
library(zoo)
library(estimatr)
library(ggpmisc)
library(ggthemes)
library(ggtext)
#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")

#weights (either unity (1) or population (2))
wgt <- 1
end_date <- 2022
start_date <- 2019
```

The World Bank released new Statistical Performance Indicators (SPI) alongside the World Development Report in March 2021. The SPI are designed to offer a forward-looking framework, relevant for at least the next 10-15 years, that provides countries incentives to build modern statistical systems.

The SPI framework assesses the maturity and performance of national statistical systems in five key areas, called pillars.  The five pillars are:

**Data Use**: Statistics have value only if they are used. So the first pillar is data use. A successful statistical system produces data that are used widely and frequently.

**Data Services**: A range of services connects data users to producers and facilitate dialogues between them, thus building trust and a sense of value.

**Data Products**: The dialogues between users and producers drive the design and range of statistical products and their accuracy, timeliness, frequency, comparability, and levels of disaggregation. The products signal whether countries are able to produce indicators related to the 17 Sustainable Development Goals.

**Data Sources**: To create useful products, the statistical system needs to draw on sources inside and outside the government. Data collection thus goes beyond the typical censuses and surveys to include administrative and geospatial data as well as data generated by private firms and citizens.

**Data Infrastructure**: A mature statistical system has well-developed hard infrastructure (legislation, governance, standards) and soft infrastructure (skills, partnerships) as well as the financial resources to deliver useful—and widely used—data products and services.

Each of these pillars is supported by four or five dimensions and uses defined methods and indicators, all available as open data and open code.  More details on the SPI can be found in a [working paper](https://documents.worldbank.org/en/publication/documents-reports/documentdetail/440191616164007723) and [technical note](https://documents.worldbank.org/en/publication/documents-reports/documentdetail/815721616086786412).

# What's Not New?

Before discussing the changes to the indicator values in the new SPI release, it is first important to discuss what has not changed.  

There have been no changes to the SPI framework.  The SPI framework contains a set of 5 pillars and a total of 22 dimensions mapped to the 5 pillars.  Data is available for 14 out of the 22 dimensions of the SPI. Eight of the 22 dimensions currently lack a methodology for creating globally comparable indicators.  While a research agenda is underway to produce globally comparable indicators in these areas, even where there are no good sources, the SPI framework can help provide for a structured conversation that covers all areas of missing data.  For instance, a discussion can be had on whether the statistical system providing useful data to the national government (legislature and executive branches), to civil society, and to academia.  Whether the NSO provide advisory and analytical services, such as data stewardship services?  Or does the country have the right skills and effective partnerships between entities in the national statistical system? 

*Figure 1. The SPI Framework*

![](SPI_dashboard.png)


There have been no changes to the methodology of scoring the indicators or producing the overall scores.  Each of the 51 indicators are scored in the same way as the previous release in 2019.  Thus all newly released data is comparable with that of the prior release.  For more details on the scoring methodology, please consult the [SPI technical note](ttps://documents.worldbank.org/en/publication/documents-reports/documentdetail/815721616086786412).

There have been no changes to the sources used for the SPI.  The SPI relies primarily on data collected by international organizations such as the World Bank, IMF, Open Data Watch, PARIS21, ILO, WHO, UNESCO, IHSN, UN, and FAO. Some indicators are also collected by visiting the website of the national statistical office. The underlying information has been updated from these sources for the years 2020, 2021, and 2022. For more details on the data sources used, please consult the [SPI technical note](ttps://documents.worldbank.org/en/publication/documents-reports/documentdetail/815721616086786412).



```{r themes}

#ggplot theme
theme_spi <- function () { 
    theme_bw() %+replace%
    theme(
      plot.caption = element_text(hjust = 0),
      plot.title=element_blank() #remove all titles from plots (sometimes we may need to bring title outside plot)
    )
}


```

```{r data}

spi_index_df<-read_csv( file = paste(output_dir, 'SPI_index.csv', sep="/")) 
# %>%
#   filter(date>=2021) %>%
#   bind_rows(read_csv( file = paste(output_dir, 'SPI_index_2020.csv', sep="/")) %>% filter(date==2020)) %>%
#   bind_rows(read_csv( file = paste(output_dir, 'SPI_index_2019.csv', sep="/")) %>% filter(date<2020))            
  

```


```{r programs, include=FALSE}


#For mapping the result
# quality = "high"
# maps <- wbgmaps::wbgmaps[[quality]]
#load world bank map data
load(paste0(raw_dir, '/misc/maps.Rdata'))
standard_crop_wintri <- function() {
  l <- list(
    left=-12000000, right=16396891,
    top=9400000, bottom=-6500000
  )
  l$xlim <- c(l$left, l$right)
  l$ylim <- c(l$bottom, l$top)
  l
}


country_metadata <- wbstats::wbcountries()




spi_mapper  <- function(data, indicator, title) {
  
 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( iso3c) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))     


  spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top Quintile",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  
  #set color pallete
  col_pal <- c("#2ec4b6","#acece7","#f1dc76","#ffbf69","#ff9f1c")  
  names(col_pal) <- c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  
  p1<-ggplot() +
    geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
    geom_path(data = maps$boundaries,
              aes(long, lat, group = group),
              color = "white",
              size = 0.3,
              lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_manual(
      name='SPI Score',
      values=col_pal,
      na.value='grey'
    ) +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      caption = 'Source: World Bank. Statistical Performance Indicators'
    )
 print(p1)
}

spi_region_charts  <- function(data, indicator, title) {
  
    map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( iso3c) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))  
    
    
    
    
  #add histogram by region 
  region_SPI_df <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    arrange(-`SPI Score`) 
  
  region_order <- c("Sub-Saharan Africa " ,
                    "South Asia",
                    "North America",
                    "Middle East & North Africa",
                    "Latin America & Caribbean ",
                    "Europe & Central Asia", 
                    "East Asia & Pacific"
                           )

  region_SPI_df <- region_SPI_df %>%
    mutate(region=factor(region, levels=region_order))
  
   p2 <-  ggplot(region_SPI_df, aes(x=`SPI Score`, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')


  # p2_alt <- map_df %>%
  #   ungroup() %>%
  #   filter(region!='Aggregates') %>%
  #   mutate(`SPI Score`=(data_available),
  #          Label = paste(round(`SPI Score`,0))) %>%
  #   ggplot(aes(x=`SPI Score`, y=region, color=region)) +
  #     geom_point() +
  #     geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
  #     labs(
  #     title=str_wrap(paste(title, 'By Country', sep=" - "),100),
  #     caption = 'Source: World Bank. Statistical Performance Indicators.',
  #     subtitle= paste0('Based on data for ',end_date,' or the latest year available')
  #     ) +
  #     expand_limits(x=c(0,100)) +
  #     theme_spi() +
  #     theme(legend.position = 'top')  
  

  print(p2)
  


    
}

spi_income_charts  <- function(data, indicator, title) {
  
    map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( iso3c) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))  
    
    
    
    


  # p2_alt <- map_df %>%
  #   ungroup() %>%
  #   filter(region!='Aggregates') %>%
  #   mutate(`SPI Score`=(data_available),
  #          Label = paste(round(`SPI Score`,0))) %>%
  #   ggplot(aes(x=`SPI Score`, y=region, color=region)) +
  #     geom_point() +
  #     geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
  #     labs(
  #     title=str_wrap(paste(title, 'By Country', sep=" - "),100),
  #     caption = 'Source: World Bank. Statistical Performance Indicators.',
  #     subtitle= paste0('Based on data for ',end_date,' or the latest year available')
  #     ) +
  #     expand_limits(x=c(0,100)) +
  #     theme_spi() +
  #     theme(legend.position = 'top')  
  
  #by income
    income <- c("Low income", "Lower middle income","Upper middle income","High income")

    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
    


  print(p3)


}

spi_time_charts  <- function(data, indicator, title) {
  

    
  # #add line graph over time
  p4 <- get(data)  %>%
    rename(data_available=!! indicator) %>%
    # right_join(spi_df_empty) %>%
    group_by(income, date) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ungroup() %>%
    ggplot(aes(y=`SPI Score`, x=date, color=income)) +
      geom_point() +
      geom_line() +
      # geom_text_repel(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Date', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.'
      ) +
      expand_limits(y=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
  

            
      


  print(p4)
    
}

spi_country_charts  <- function(data, indicator, title) {
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( iso3c) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    filter(region!="Aggregates") %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
   spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top Quintile",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  
  #set color pallete
  col_pal <- c("#2ec4b6","#acece7","#f1dc76","#ffbf69","#ff9f1c")  
  names(col_pal) <- c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  

  region_order <- c("Sub-Saharan Africa " ,
                    "South Asia",
                    "North America",
                    "Middle East & North Africa",
                    "Latin America & Caribbean ",
                    "Europe & Central Asia", 
                    "East Asia & Pacific"
                           )
  
  p2_alt <- SPI_map %>%
    ungroup() %>%
    mutate(region=factor(region, levels=region_order)) %>%
    ggplot(aes(x=data_available, y=region, color=spi_groups)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Country', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      xlab('Score') +
      expand_limits(x=c(0,100)) +
      scale_color_manual(
        name='SPI Score',
        values=col_pal,
        na.value='grey'
      ) +
      theme_spi() +
      theme(legend.position = 'top') 
   
p2_alt

}


spi_maturity_table <- function(data, indicators, reference_year) {

      df_overall <- get(data) %>%
      filter(date==as.numeric(reference_year)) %>% 
      select(iso3c, date, income, region, all_of(indicators), SPI.INDEX) 
    
    
    spi_groups_quantiles <- quantile(df_overall$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)
    
    df_overall <- df_overall %>%
      mutate(spi_groups=case_when(
        between(SPI.INDEX, spi_groups_quantiles[4],100) ~ "Top Quintile",
        between(SPI.INDEX, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
        between(SPI.INDEX, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
        between(SPI.INDEX, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
        between(SPI.INDEX, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      )) %>%
      mutate(spi_groups=factor(spi_groups, 
                               levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
    
    #produce by income
    sumstats<- df_overall %>%
      group_by(spi_groups) %>%
      filter(!is.na(spi_groups)) %>%
      select(spi_groups, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    #produce global number
    sumstats_gl<- df_overall %>%
      mutate(spi_groups='Global') %>%
      group_by(spi_groups) %>%
      select(spi_groups, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    
    #transpose data
    sumstats_df_long <-sumstats 
    
    sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-spi_groups)))
    colnames(sumstats_df) = sumstats_df_long$spi_groups 
    
    
    sumstats_df <- sumstats_df %>%
      rownames_to_column() %>%
      rename(series=rowname)
    
    
    #create labels df
    metadata_tab2_overall <- metadata_full %>% 
      janitor::clean_names() %>%
      transmute(series=source_id, 
                indicator_name=source_name)
    
    
    #add variable label
    sumstats_df <- sumstats_df %>%
      left_join(metadata_tab2_overall) %>%
      rename(Series=series,
             Label=indicator_name) %>%
      mutate(Label=if_else(is.na(Label),Series,Label)) %>%
      select(Label, c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" ))

      sumstats_df
 

}


spi_group_table <- function(data, indicators, reference_year, group) {

      df_overall <- get(data) %>%
      filter(date==as.numeric(reference_year)) %>% 
      left_join(country_metadata) %>%
      select(iso3c, date, income, region, lending, all_of(indicators), SPI.INDEX) %>%
      rename(group=!! group)
    
    
    
    #produce by income
    sumstats<- df_overall %>%
      group_by(group) %>%
      filter(!is.na(group)) %>%
      select(group, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    #produce global number
    sumstats_gl<- df_overall %>%
      mutate(group='Global') %>%
      group_by(group) %>%
      select(group, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    
    #transpose data
    sumstats_df_long <-sumstats 
    
    sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-group)))
    colnames(sumstats_df) = sumstats_df_long$group 
    
    
    sumstats_df <- sumstats_df %>%
      rownames_to_column() %>%
      rename(series=rowname)
    
    
    #create labels df
    metadata_tab2_overall <- metadata_full %>% 
      janitor::clean_names() %>%
      transmute(series=source_id, 
                indicator_name=source_name)
    
    
    #add variable label
    sumstats_df <- sumstats_df %>%
      left_join(metadata_tab2_overall) %>%
      rename(Series=series,
             Label=indicator_name) %>%
      mutate(Label=if_else(is.na(Label),Series,Label)) %>%
      select(Label, everything()) %>%
      select(-Series)

      sumstats_df
 

}

lending_charts <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( iso3c) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  p2_alt3 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=(data_available),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=lending, color=lending)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top',
            title= element_text(size = 20),
            axis.title.y=element_blank(),
            text = element_text(size = 14)) 
   
p2_alt3 
  
 
}

lending_chart_aggregate <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( iso3c) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  

  p2_alt3 <- map_df %>%
    group_by(lending) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=lending, fill=lending)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
            # title= element_text(size = 20),
            # axis.title.y=element_blank(),
            # text = element_text(size = 14)) 
   
p2_alt3 
  
 
}



fcs_charts <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( iso3c) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=(data_available),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=fcs, color=fcs)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
            #text=element_text(size=14)) 
   
p2_alt2 
  
 
}


fcs_chart_aggregate <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( iso3c) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    group_by(fcs) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=fcs, fill=fcs)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = str_wrap('Source: World Bank. Statistical Performance Indicators. Non-FCS countries include all countries not classified as FCS.  This includes high income countries.',70),
      subtitle= paste0('Based on data for ',end_date,' or the latest year available')
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
            #text=element_text(size=14)) 
  
  
  
p2_alt2 
  
 
}


#define function to pull data from UN Stats and return
un_pull <- function(series,start, end) {
  # jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&timePeriodStart=',start,'&timePeriodEnd=',end,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%
      jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%

    as_tibble() %>%
    mutate(date=timePeriodStart) %>%
    right_join(iso3c)
    
}  

FitFlextableToPage <- function(ft, pgwidth = 6){

  ft_out <- ft %>% 
    add_footer_lines(values = "Source: World Bank. Statistical Performance Indicators."                 ) %>%
    autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

#add equations to plots
eq_plot_txt <- function(data) {
  eq <- lm_robust(SPI.INDEX ~ value, data=data, se_type='HC2')
  coef <- coef(eq)
  std_err <- sqrt(diag(vcov(eq)))
  r_2<- summary(eq)$r.squared
  sprintf("y = %.3f + %.3f x, R<sup>2</sup> = %.3f <br>    (%.3f)   (%.3f)", coef[1], coef[2], r_2[1], std_err[1], std_err[2])

}

```


# What is New?

The next section discusses how the values of the indicators have changed since `r start_date` and `r end_date`.  First, a discussion will be given of countries that have shown particular large changes in the SPI overall score, and the pillars that have seen the most change.  Next, a discussion of regional patterns is given.


The SPI Overall Score is available for `r nrow(spi_index_df %>% filter(!is.na(SPI.INDEX)) %>% filter(date==2022))` economies in 2022.  These `r nrow(spi_index_df %>% filter(!is.na(SPI.INDEX)) %>% filter(date==2022))` economies cover 99.3 percent of the world population.  There has been an increase in the number of economies with an SPI overall score since 2016, with a rise from 167 economies to `r nrow(spi_index_df %>% filter(!is.na(SPI.INDEX)) %>% filter(date==2022))`.  This is largely driven by an increase in the number of economies with a data openness score from [Open Data Watch](https://odin.opendatawatch.com/). While an SPI overall score is not available for all 217 economies listed in the World Bank's World Development Indicators, there is at least partial data available for all 217 economies.  If an economy does not have data for one of the indicators used to generate the SPI overall score, no score is produced for this country, as the SPI does not rely on modelling or imputation to produce the scores.

*Figure 2. Number of Economies with SPI Overall Score.*
```{r}
spi_index_df %>%
  filter(!is.na(SPI.INDEX)) %>%
  group_by(date) %>%
  summarise(n=n()) %>%
  mutate(date=factor(date,levels=c(2016:2022))) %>%
  ggplot(aes(x=date, y=n, label=n)) +
    geom_col(fill='#8ecae6') +
    geom_text(nudge_y = -5, size=5 ) +
    theme_minimal() +
    xlab("Year") +
    ylab('Number of Economies') +
    expand_limits(y=c(0,217))
```
 

## How Have Country Scores Changed Between `r start_date` and `r end_date`



```{r changes}
#create a dataframe for the 2019 SPI to calculate changes since 2019

spi_index_end_date <- spi_index_df %>%
  filter(date==end_date) %>%
  filter(!is.na(SPI.INDEX))

spi_index_start_date <- spi_index_df %>%
  filter(date==start_date) %>%
  filter(!is.na(SPI.INDEX)) %>%
  mutate(SPI.INDEX.start_date=SPI.INDEX) %>%
  select(iso3c, region, SPI.INDEX.start_date)

spi_changes <- spi_index_end_date %>%
  mutate(SPI.INDEX.end_date=SPI.INDEX) %>%
  select(iso3c, country,region, SPI.INDEX.end_date) %>%
  left_join(spi_index_start_date)


#correlation
corr_end_date_start_date <- cor(spi_changes$SPI.INDEX.end_date,spi_changes$SPI.INDEX.start_date, use='pairwise.complete.obs')
spearman_end_date_start_date <- spearman(spi_changes$SPI.INDEX.end_date,spi_changes$SPI.INDEX.start_date)

changes <- spi_changes$SPI.INDEX.end_date - spi_changes$SPI.INDEX.start_date
avg_change <- mean(changes, na.rm=TRUE)
deciles <- quantile(changes, probs = seq(from=0, to=1, by=.1), na.rm=TRUE)


```

In order to assess how much change exists in the index values are over time, comparisons are made between the index values in `r start_date` and the `r end_date` values.  On average across countries, between `r start_date` and `r end_date` the SPI overall scores rose by `r round(avg_change, 1)` points on a scale from 0-100. The change between `r start_date` and `r end_date` for the 10th percentile was `r round(deciles[2], 1)` and the change for the 90th percentile was `r round(deciles[10], 1)`.  

The rankings of countries by the SPI overall score was quite stable over time.  The Spearman rank correlation between the `r start_date` value and the `r end_date` value is `r round(spearman_end_date_start_date,2)`.

*Figure 3: Scatterplot of `r end_date` SPI overall score  & `r start_date` SPI overall score*
```{r changesplot}

ggplot(spi_changes, aes(x=SPI.INDEX.start_date, y=SPI.INDEX.end_date, color=region)) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm', color='blue') +
  geom_segment(aes(x=10,xend=100, y=10,yend=100), color='grey') +
  expand_limits(x=c(10,100),y=c(10,100)) +
  theme_spi() +
  labs(
    title=paste0('Scatterplot of ',end_date,' SPI overall score  & ',start_date,' SPI overall score'),
    caption = 'Solid grey line represents the 45 degree line.  Blue line represents line of best fit (regression line) with a 95% confidence interval shown in a shaded line.'
  ) +
  ylab(paste0(end_date,' SPI Overall Score')) +
  xlab(paste0(start_date,' SPI Overall Score')) +
  theme(legend.position = 'bottom') +
    stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     color='blue',
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4) +
  guides(
    size="none"
  )


```


```{r top_bottom_changes}

top_changes <- spi_changes %>%
  mutate(changes=SPI.INDEX.end_date-SPI.INDEX.start_date) %>%
  arrange(-abs(changes)) %>%
  select(country,SPI.INDEX.end_date,SPI.INDEX.start_date, changes) %>%
  mutate(across(c('SPI.INDEX.end_date','SPI.INDEX.start_date', 'changes'),round,1))

top_mover <- as.character(top_changes[1,1])
top_mover_change <- as.numeric(top_changes[1,4])
```


```{r}
changers <-  head(top_changes, 10) %>% pluck(1)

changers_data <- spi_index_df %>%
  filter(date==2022 | date==2019) %>%
  filter(country %in% changers) 
  

changers_text <- data.frame(
  country=changers,
  text = c("Somalia improved greatly in the Data Use and Data Infrastructure Pillar.",
           "Iraq improved greatly in Data Services, including data openness, and by improving the CRVS.",
           'Kiribati improved on reporting on SDG indicators (Pillar 3) and data openness.',
           'The United Arab Emirates improved on data openness and  reporting on the SDGs',
           'Saudi Arabia made improvemens on data openness, SDG reporting, and data infrastructure.',
           'Seychelles improved on data use, reporting on the SDGs, and data infastructure.',
           'Congo, Dem. Rep. improved on data openness and on reporting on SDG Indicators.',
           'The Gambia improved on Data Services and Data infrastructure',
           'Jordan has improved in data infrastructure, and also data sources, data products, and data services.',
           'Uzbekistan improved on data openness, SDG reporting, as well as data sources and infrastructure.'
           
           )
)

```


While the rankings between countries were relatively stable over time, some countries did see large improvements in their score from `r start_date`-`r end_date`. The country that improved most on the index from `r start_date` to `r end_date` was `r top_mover`. `r top_mover` improved by `r top_mover_change` points out of 100. The table below shows the changes in the SPI overall score for the top 10 largest improvers.


*Table 2: Top 10 Countries with Largest Changes from `r start_date`-`r end_date`.*
```{r topbottomchangestab}
top_changes_tab <- flextable(head(top_changes,10) %>% left_join(changers_text)) %>%
  # add_header_lines('Top 10 Countries with Largest Changes from start_date-2020.') %>%
  set_header_labels(values=list(
                       country="Country",
                       SPI.INDEX.end_date=paste0("SPI Overall Score ",end_date),
                       SPI.INDEX.start_date=paste0("SPI Overall Score ",start_date),
                       changes="Difference",
                       text = "Improvements"
                                   )) 

FitFlextableToPage(top_changes_tab) %>%
  width(width=1.2) %>%
  align( align = "left", part = "body")
```


```{r}
bottom_changes <- top_changes %>%
  filter(changes<0) %>%
  arrange(changes)

bottom_mover <- as.character(bottom_changes[1,1])
bottom_mover_change <- as.numeric(bottom_changes[1,4])
```

A few countries saw their SPI overall score drop between `r start_date` and `r end_date`.  The country with the largest drop (decrease in scores) was `r bottom_mover` with a decrease in the SPI overall score of `r round(bottom_mover_change,1)`.


*Table 3: Top Countries with Largest Drops from `r start_date`-`r end_date`.*
```{r bottomchangestab}
bottom_changes_tab <- flextable(head(bottom_changes,10)) %>%
  # add_header_lines('Top 10 Countries with Largest Changes from start_date-2020.') %>%
  set_header_labels(values=list(
                       country="Country",
                       SPI.INDEX.end_date=paste0("SPI Overall Score ",end_date),
                       SPI.INDEX.start_date="SPI Overall Score start_date",
                       changes="Difference"
                                   )) 

FitFlextableToPage(bottom_changes_tab) %>%
  width(width=1.2) %>%
  align( align = "left", part = "body")
```

In the following map, countries that improved by more than 5 points on the 0-100 scale are shown in dark green, countries that improved by between 2 and 5 points in light green, countries that saw decreases between 2 and 5 points in light red, and countries that say decreases of more than 5 points in dark red.  Countries with a change of less than 2 points in either direction are shaded in light blue.

Figure 2. Global Changes to SPI Overall Scores from `r start_date`-`r end_date`.
```{r changes_map}

title <- paste0("Changes in SPI Overall Scores between ",start_date," and ",end_date,".")

#create dataset with changes between end_date and 2019
  map_df <- spi_changes %>%
    select(iso3c, SPI.INDEX.end_date, SPI.INDEX.start_date) %>%
    right_join(country_metadata)
    
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      SPI.INDEX.end_date-SPI.INDEX.start_date > 5 ~ "Improved >5 points",
      between(SPI.INDEX.end_date-SPI.INDEX.start_date, 2,5) ~ "Improved 2-5 points",
      between(SPI.INDEX.end_date-SPI.INDEX.start_date, -2,2) ~ "Little Change",
      between(SPI.INDEX.end_date-SPI.INDEX.start_date, -5,-2) ~ "Dropped 2-5 points",
      SPI.INDEX.end_date-SPI.INDEX.start_date < -5 ~ "Dropped >5 points"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Improved >5 points","Improved 2-5 points","Little Change","Dropped 2-5 points","Dropped >5 points" )))  
  
  #set color pallete
  col_pal <- c("#0B3954","#087E8B","#BFD7EA","#FF5A5F","#C81D25")  
  names(col_pal) <- c("Improved >5 points","Improved 2-5 points","Little Change","Dropped 2-5 points","Dropped >5 points")
  
  p1<-ggplot() +
    geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
    geom_path(data = maps$boundaries,
              aes(long, lat, group = group),
              color = "white",
              size = 0.3,
              lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_manual(
      name='SPI Changes',
      values=col_pal,
      na.value='grey',
      drop=FALSE
    ) +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      caption = 'Source: World Bank. Statistical Performance Indicators'
    )
 print(p1)

```




```{r elephant, echo=FALSE, dpi=250, message=FALSE, warning=FALSE, fig.height=8, fig.width=14}

growth_plot <- function(variables, name) {
  


  elephant_df <- spi_index_df %>%
    rename(spi_data=!! variables) %>%
    select( iso3c, date, spi_data) %>%
    group_by(iso3c, date) %>%
    mutate(row = row_number()) %>%
    pivot_wider(names_from=date,
                names_prefix='spi_data_',
                values_from=c('spi_data')) %>%
    rename(spi_data_end_date=!! paste0('spi_data_',end_date),
           spi_data_start_date=!! paste0('spi_data_',start_date)) %>%
    ungroup() %>%
    mutate(growth=(spi_data_end_date-spi_data_start_date)) %>%
    filter(!(is.na(spi_data_end_date) | is.na(spi_data_start_date))) %>%
    mutate(spi_rank=100*rank(spi_data_start_date)/length(spi_data_start_date),
           spi_bins=case_when( #calculate deciles
             between(spi_rank,0,10) ~ "1st Decile",
             between(spi_rank,10,20) ~ "2nd Decile",
             between(spi_rank,20,30) ~ "3rd Decile",
             between(spi_rank,30,40) ~ "4th Decile",
             between(spi_rank,40,50) ~ "5th Decile",
             between(spi_rank,50,60) ~ "6th Decile",
             between(spi_rank,60,70) ~ "7th Decile",
             between(spi_rank,70,80) ~ "8th Decile",
             between(spi_rank,80,90) ~ "9th Decile",
             between(spi_rank,90,100) ~ "Top Decile"
           )) %>%
    arrange(spi_rank)
  
  #summarise into decile bins
  elephant_df <- elephant_df %>%
    mutate(spi_bins=factor(spi_bins, levels=unique(elephant_df$spi_bins))) %>%
    group_by(spi_bins) %>%
    summarise(growth=mean(growth))
  
  ggplot(elephant_df, aes(x=spi_bins, y=growth, label=paste0(spi_bins,": ",round(growth,1),""))) +
    geom_segment(aes(xend=as.numeric(spi_bins)-0.5,x=as.numeric(spi_bins)+0.5, y=growth, yend=growth)) +
    geom_point() +
    geom_bar(aes(alpha=growth), stat = "identity", fill='#007f5f') +
    ggrepel::geom_text_repel(nudge_y=0.1, size=4,segment.alpha =  0 ) +
    scale_x_discrete() +
    theme_bw() +
    xlab(str_wrap(paste0('Decile in ',start_date),40)) +
    ylab(str_wrap(paste0('Change in Score (',start_date,'-',end_date,')'),20)) +
    labs(
      #title=str_wrap("2nd & 3rd deciles have improved most since 2019.",70),
      subtitle=str_wrap(paste0('Change in SPI Overall Score from ',start_date,'-',end_date,' by 2019 decile group'),70),
      caption=paste0(name,' scale = 0 - 100 points.')
    ) +
    expand_limits(y=0) +
    scale_alpha_continuous(
      range=c(0.3,1)
    ) +
    expand_limits(y=c(-2,3)) +
  theme(
    axis.title.y = element_text(angle=0, vjust = 0.5),
    text = element_text(size = 14),
    title= element_text(size = 20),
    legend.position = 'none'
  )

}


# growth_plot('SPI.INDEX.PIL1', 'SPI Pillar 1 (Data Use) Score')
# growth_plot('SPI.INDEX.PIL2', 'SPI Pillar 2 (Data Services) Score')
# growth_plot('SPI.INDEX.PIL3', 'SPI Pillar 3 (Data Products) Score')
# growth_plot('SPI.INDEX.PIL4', 'SPI Pillar 4 (Data Sources) Score')
# growth_plot('SPI.INDEX.PIL5', 'SPI Pillar 5 (Data Infrastructure) Score')


```


Between `r start_date` & `r end_date` the largest improvements in the SPI overall score have come from countries that were in the bottom two deciles as of `r start_date`. Countries that were in the bottom 10% (first decile) in 2019 grew on average around 10 points from `r start_date`-`r end_date`.  Countries in the second decile improved nearly 11 points.  Countries in the top 10% (top decile) grew the least in that time, likely due to many of these countries scoring the maximum (or close to the maximum) number of points in several areas.

Figure 3. Bottom Two Deciles Have Improved Most from `r start_date`-`r end_date`.
```{r elplot, echo=FALSE, dpi=250, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}

growth_plot('SPI.INDEX', 'SPI Overall Score')

```






```{r elephantstacked, echo=FALSE, dpi=250, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}



  elephant_stacked_df <- spi_index_df %>%
    select( iso3c, date, starts_with('SPI.INDEX')) %>%
    group_by(iso3c, date) %>%
    mutate(row = row_number()) %>%
    pivot_wider(names_from=date,
                values_from=starts_with('SPI.INDEX')) %>%
    rename(SPI.INDEX_end_date=!! paste0('SPI.INDEX_',end_date),
           SPI.INDEX.PIL1_end_date=!! paste0('SPI.INDEX.PIL1_',end_date),
           SPI.INDEX.PIL2_end_date=!! paste0('SPI.INDEX.PIL2_',end_date),
           SPI.INDEX.PIL3_end_date=!! paste0('SPI.INDEX.PIL3_',end_date),
           SPI.INDEX.PIL4_end_date=!! paste0('SPI.INDEX.PIL4_',end_date),
           SPI.INDEX.PIL5_end_date=!! paste0('SPI.INDEX.PIL5_',end_date),
           SPI.INDEX_start_date=!! paste0('SPI.INDEX_',start_date),
           SPI.INDEX.PIL1_start_date=!! paste0('SPI.INDEX.PIL1_',start_date),
           SPI.INDEX.PIL2_start_date=!! paste0('SPI.INDEX.PIL2_',start_date),
           SPI.INDEX.PIL3_start_date=!! paste0('SPI.INDEX.PIL3_',start_date),
           SPI.INDEX.PIL4_start_date=!! paste0('SPI.INDEX.PIL4_',start_date),
           SPI.INDEX.PIL5_start_date=!! paste0('SPI.INDEX.PIL5_',start_date)) %>%
    ungroup() %>%
    mutate(overall_growth=(SPI.INDEX_end_date-SPI.INDEX_start_date),
           dim1_growth=(SPI.INDEX.PIL1_end_date-SPI.INDEX.PIL1_start_date),
           dim2_growth=(SPI.INDEX.PIL2_end_date-SPI.INDEX.PIL2_start_date),
           dim3_growth=(SPI.INDEX.PIL3_end_date-SPI.INDEX.PIL3_start_date),
           dim4_growth=(SPI.INDEX.PIL4_end_date-SPI.INDEX.PIL4_start_date),
           dim5_growth=(SPI.INDEX.PIL5_end_date-SPI.INDEX.PIL5_start_date)
           ) %>%
    filter(!(is.na(SPI.INDEX_end_date) | is.na(SPI.INDEX_start_date))) %>%
    mutate(spi_rank=100*rank(SPI.INDEX_start_date)/length(SPI.INDEX_start_date),
           spi_bins=case_when( #calculate deciles
             between(spi_rank,0,10) ~ "1st Decile",
             between(spi_rank,10,20) ~ "2nd Decile",
             between(spi_rank,20,30) ~ "3rd Decile",
             between(spi_rank,30,40) ~ "4th Decile",
             between(spi_rank,40,50) ~ "5th Decile",
             between(spi_rank,50,60) ~ "6th Decile",
             between(spi_rank,60,70) ~ "7th Decile",
             between(spi_rank,70,80) ~ "8th Decile",
             between(spi_rank,80,90) ~ "9th Decile",
             between(spi_rank,90,100) ~ "Top Decile"
           )) %>%
    arrange(spi_rank)
  
  #summarise into decile bins
  elephant_stacked_df <- elephant_stacked_df %>%
    mutate(spi_bins=factor(spi_bins, levels=unique(elephant_stacked_df$spi_bins))) %>%
    group_by(spi_bins) %>%
    summarise(
              D1=mean(dim1_growth),
              D2=mean(dim2_growth),
              D3=mean(dim3_growth),
              D4=mean(dim4_growth),
              D5=mean(dim5_growth)) %>%
    pivot_longer(
      cols=c('D1', 'D2', 'D3', 'D4', 'D5'),
      values_to='growth',
      names_to='pillar'
    ) %>%
    mutate(pillar=case_when(
      pillar=="D1" ~ "Pillar 1: Data Use",
      pillar=="D2" ~ "Pillar 2: Data Services",
      pillar=="D3" ~ "Pillar 3: Data Products",
      pillar=="D4" ~ "Pillar 4: Data Sources",
      pillar=="D5" ~ "Pillar 5: Data Infrastructure"
    )) %>%
    mutate(growth=growth/5) #divide by 5 so that pillar scores sum to overall score.  This puts equal weight on each pillar in the sum
  






```

A large amount of the growth in the SPI overall score came from improvements in the Data Products pillar.  This pillar covers how well countries are reporting on data related to the Sustainable Development Goals (SDGs).  Countries in the bottom 10% saw a contribution of 4.2 out of the total of 10.3 total points (around 40%) of improvement from better SDG reporting.  A little over 23% of the improvement came from better data services, such as more open data.  A little over 20% came from better data infrastructure, such as adoption of better standards and methodologies for producing data.  

In some cases, the scores for decile groups dropped for certain pillars, such as data use, which can happen if data that is available becomes stale for that country (falls outside the window dictated by the indicator scoring).

Figure 4. Data Products and Data Infrastructure Saw Major Improvements from `r start_date`-`r end_date`.

```{r elplotstacked, echo=FALSE, dpi=250, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
name <- 'SPI Overall Score'

  ggplot(elephant_stacked_df, aes(x=spi_bins, y=growth, fill=pillar, label=paste0(round(growth,1)))) +
    geom_bar(stat = "identity", position='stack') +
    geom_text(size = 4, position = position_stack(vjust = 0.5)) +
    scale_x_discrete() +
    theme_bw() +
    xlab(str_wrap(paste0('Decile in ',start_date),40)) +
    ylab(str_wrap(paste0('Change in Score (',start_date,'-',end_date,')'),20)) +
    labs(
      #title=str_wrap("Countries in 2nd and 3rd deciles have grown most since 2019.",70),
      subtitle=str_wrap(paste0('Change in SPI Overall Score from ',start_date,'-',end_date,' by ',start_date,' decile group'),70),
      caption=paste0(name,' scale = 0 - 100 points.')
    ) +
    expand_limits(y=c(-2,3)) +
  theme(
    axis.title.y = element_text(angle=0, vjust = 0.5),
    text = element_text(size = 14),
    title= element_text(size = 20),
    legend.position = 'bottom'
  ) +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))

```

## How Have Regional Scores Changed?

Next, a comparison is given between the regional overall scores in 2019 and those in 2022.  Scores will be broken down in two ways.  First, an unweighted average of the scores across countries.  Second, an regional average weighted by the population size of the country.


Figure 5. Comparison of SPI Overall Scores in 2019 and 2022 - Unweighted Regional Averages
```{r}

reg_avg <- spi_index_df %>%
  filter(date==2016 | date==2019 | date==2022) %>%
  group_by(date, region) %>%
  summarise(SPI.INDEX=mean(SPI.INDEX, na.rm=TRUE)) %>%
  mutate(date=factor(date, levels=c(2016, 2019,2022)),
         region=factor(region, levels=c("North America", "Europe & Central Asia", "East Asia & Pacific","South Asia", "Latin America & Caribbean", "Middle East & North Africa", "Sub-Saharan Africa")))

ggplot(reg_avg, aes(x=region,y=SPI.INDEX, fill=date,group = region,label=round(SPI.INDEX,0))) +
  geom_col(position = 'dodge2') +
  geom_text(position = position_dodge2(width = 1), size=4) +
  ylab("SPI Overall Score") +
  ggtitle('Unweighted Regional Average of SPI Overall Score by Year') +
  theme_minimal() +
  theme(legend.position='top',
        text = element_text(size = 14),
        axis.text.x=element_text(size = 14)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15))

```

Figure 6. Comparison of SPI Overall Scores in 2019 and 2022 - Population Weighted Regional Averages
```{r}

reg_w_avg <- spi_index_df %>%
  filter(date==2016 | date==2019 | date==2022) %>%
  group_by(date, region) %>%
  summarise(SPI.INDEX=wtd.mean(SPI.INDEX, na.rm=TRUE, w=population)) %>%
  mutate(date=factor(date, levels=c(2016, 2019,2022)),
         region=factor(region, levels=c("North America", "Europe & Central Asia", "Latin America & Caribbean","South Asia", "East Asia & Pacific",  "Middle East & North Africa", "Sub-Saharan Africa")))

ggplot(reg_w_avg, aes(x=region,y=SPI.INDEX, fill=date,group = region,label=round(SPI.INDEX,0))) +
  geom_col(position = 'dodge2') +
  geom_text(position = position_dodge2(width = 1)) +
  ylab("SPI Overall Score") +
  ggtitle('Population Weighted Regional Average of SPI Overall Score by Year') +
  theme_minimal() +
    theme(legend.position='top',
        text = element_text(size = 14),
        axis.text.x=element_text(size = 14)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15))

```

```{r eval=FALSE, include=FALSE}
#| label: SAR
#| fig-cap: 
#Comparison of SPI Overall Scores in 2016, 2019, and 2022 - SAR

#SAR

sar_avg <- spi_index_df %>%
  filter(region=="South Asia") %>%
  filter(date==2016 | date==2019 | date==2022) %>%
  mutate(
    date=factor(date, levels=c(2016, 2019,2022))
  ) %>%
  arrange(date)


ggplot(sar_avg, aes(x=country,y=SPI.INDEX, fill=date,group = country,label=round(SPI.INDEX,0))) +
  geom_col(position = 'dodge2') +
  geom_text(position = position_dodge2(width = 1), size=4) +
  ylab("SPI Overall Score") +
  ggtitle('SPI Overall Score by Year') +
  theme_minimal() +
  theme(legend.position='top',
        text = element_text(size = 14),
        axis.text.x=element_text(size = 14)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15))
```


## How Have Scores by Income Group Changed



Finally, a comparison is given between the income group overall scores over time.  Scores again will be broken down in two ways.  First, an unweighted average of the scores across countries.  Second, an regional average weighted by the population size of the country.


Figure 7. Comparison of SPI Overall Scores from 2016 to 2022 - Unweighted Income Group Averages
```{r}

inc_avg <- spi_index_df %>%
  filter(date>=2016 ) %>%
  filter(income!="Not classified") %>%
  group_by(date, income) %>%
  summarise(SPI.INDEX=mean(SPI.INDEX, na.rm=TRUE)) %>%
  mutate(date=factor(date, levels=c(2016, 2017, 2018, 2019, 2020, 2021,2022)),
         income=factor(income, levels=c("High income","Upper middle income", "Lower middle income", "Low income")))

ggplot(inc_avg, aes(x=date,y=SPI.INDEX, color=income,group = income,label=round(SPI.INDEX,0))) +
  geom_line() +
  geom_point() +
  ylab("SPI Overall Score") +
  ggtitle('Unweighted Income Group Average of SPI Overall Score by Year') +
  scale_color_manual(
    values = c(
      "Low income" = "#ffb703",
      "Lower middle income" = "#8ecae6",
      "Upper middle income" = "#219ebc",
      "High income" = "#023047"
    )
  ) +
  theme_minimal() +
  theme(legend.position='top',
        text = element_text(size = 14),
        axis.text.x=element_text(size = 14)) +
  expand_limits(y=c(0,100))

```

Figure 8. Comparison of SPI Overall Scores from 2016 to 2022 - Population Weighted Income Group Averages
```{r}

inc_w_avg <- spi_index_df %>%
  filter(date>=2016 ) %>%
  filter(income!="Not classified") %>%
  group_by(date, income) %>%
  summarise(SPI.INDEX=wtd.mean(SPI.INDEX, weights=population, na.rm=TRUE)) %>%
  mutate(date=factor(date, levels=c(2016, 2017, 2018, 2019, 2020, 2021,2022)),
         income=factor(income, levels=c("High income","Upper middle income", "Lower middle income", "Low income")))

ggplot(inc_w_avg, aes(x=date,y=SPI.INDEX, color=income,group = income,label=round(SPI.INDEX,0))) +
  geom_line() +
  geom_point() +
  ylab("SPI Overall Score") +
  ggtitle('Population Weighted Income Group Average of SPI Overall Score by Year') +
  scale_color_manual(
    values = c(
      "Low income" = "#ffb703",
      "Lower middle income" = "#8ecae6",
      "Upper middle income" = "#219ebc",
      "High income" = "#023047"
    )
  ) +
  theme_minimal() +
  theme(legend.position='top',
        text = element_text(size = 14),
        axis.text.x=element_text(size = 14)) +
  expand_limits(y=c(0,100))

# inc_avg %>%
#   rename(`Unweighted SPI Overall Score`=SPI.INDEX) %>%
#   left_join(inc_w_avg) %>%
#   rename(`Population Weighted SPI Overall Score`=SPI.INDEX) %>%
#   write_excel_csv(file=paste0(output_dir, "/SPI_income_group_averaged.csv"))

```




# Appendix

## Country SPI overall scores

Below, the full list of countries by their SPI overall score in `r end_date` is presented. The first column is the country name and the following columns are the overall SPI overall score, and then the sub-scores for pillars 1,2,3,4 and 5.

The purpose of the SPI is to help countries assess and improve the performance of their statistical systems. The presentation of SPI overall scores is designed to reflect that aim. Small differences between countries should not be highlighted since they are likely to reflect imprecision arising from the methodology rather than meaningful differences in performance. Instead, presentation of overall SPI scores focuses on larger groupings of countries reflecting broad categories of performance as measured by the indicator framework.

Countries shaded in dark orange are the lowest performing, countries in dark green are the highest performing. Countries are grouped into five groups:
 

* **Top Quintile**:  Countries in the Top quintile are classified in this group.  Shading in <span style="color:#2ec4b6">dark green</span>.    
* **4th Quintile**: Countries in the 4th quintile, or those above the 60th percentile but below the 80th percentile are in this group.  Shading in <span style="color:#acece7">light green</span>.    
* **3rd Quintile**: Countries in the 3rd quintile, or those between the 40th and 60th percentile, are classified in this group.  Shading in <span style="color:#f1dc76">yellow</span>.  
* **2nd Quintile**: Countries in the 2nd quintile, or those above the 20th percentile but below the 40th percentile, are in this group.  Shading in <span style="color:#ffbf69">light orange</span>.  
* **Bottom 20%**: Countries in the bottom 20% are classified in this group.  Shading in <span style="color:#ff9f1c">dark orange </span>.  



*Table A.1: SPI overall score in `r end_date`` and Pillar Scores*
```{r tab1, echo=FALSE}


#colors

col_palette <- c("#2ec4b6", "#acece7", "#f1dc76",  "#ffbf69","#ff9f1c"   )

col_palette2 <- c("#2ec4b6",  "#f1dc76", "#ff9f1c" )

#make the table
index_tab <- spi_index_df %>%
  filter(date==end_date) %>%
  select(country, SPI.INDEX,SPI.INDEX.PIL1,SPI.INDEX.PIL2,SPI.INDEX.PIL3,SPI.INDEX.PIL4,SPI.INDEX.PIL5) %>%
  mutate(across(starts_with("SPI.INDEX"),round,1))

 #calculate the breaks for the color coding
        brks <- quantile(index_tab$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)
        brks <- append(0,brks)
        brks <- append(brks,100)

        brks1 <- quantile(index_tab$SPI.INDEX.PIL1, probs=c(1,2,3,4)/5,na.rm=T)
        brks1 <- append(0,brks1)
        if (max(brks1)<100) brks1 <- append(brks1,100)
        
        brks2 <- quantile(index_tab$SPI.INDEX.PIL2, probs=c(1,2,3,4)/5,na.rm=T)
        brks2 <- append(0,brks2)
        if (max(brks2)<100) brks2 <- append(brks2,100)
        
        brks3 <- quantile(index_tab$SPI.INDEX.PIL3, probs=c(1,2,3,4)/5,na.rm=T)
        brks3 <- append(0,brks3)
        if (max(brks3)<100) brks3 <- append(brks3,100)
        
        brks4 <- quantile(index_tab$SPI.INDEX.PIL4, probs=c(1,2,3,4)/5,na.rm=T)
        brks4 <- append(0,brks4)
        if (max(brks4)<100) brks4 <- append(brks4,100)
        
        brks5 <- quantile(index_tab$SPI.INDEX.PIL5, probs=c(1,2,3,4)/5,na.rm=T)
        brks5 <- append(0,brks5)
        if (max(brks5)<100) brks5 <- append(brks5,100)
        

      #make nice looking
      index_tab <- index_tab %>%
        flextable() %>%
        set_header_labels(values=list(
                             country="Country",
                             SPI.INDEX="SPI overall score",
                             SPI.INDEX.PIL1="Pillar 1: Data Use",
                             SPI.INDEX.PIL2="Pillar 2: Data Services",
                             SPI.INDEX.PIL3="Pillar 3: Data Products ",
                             SPI.INDEX.PIL4="Pillar 4: Data Sources",
                             SPI.INDEX.PIL5="Pillar 5: Data Infrastructure"
                                         )) %>%
          bg(j = c('SPI.INDEX'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL1'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks1, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL2'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks2, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL3'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks3, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL4'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks4, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL5'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks5, reverse=TRUE))
# 
# #make nice looking
# index_tab <- index_tab %>%
#   flextable() %>%
#   add_header_lines('SPI overall score in 2020 and pillar Scores.') %>%
#   set_header_labels(values=list(
#                        country="Country", 
#                        SPI.INDEX="SPI overall score",
#                        SPI.INDEX.PIL1="Dim 1: Data Use",
#                        SPI.INDEX.PIL2="Dim 2: Data Services",
#                        SPI.INDEX.PIL3="Dim 3: Data Products ",
#                        SPI.INDEX.PIL4="Dim 4: Data Sources",
#                        SPI.INDEX.PIL5="Dim 5: Data Infrastructure"
#                                    )) %>%
#     bg(j = c('SPI.INDEX'), 
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL1'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL2'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL3'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL4'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL5'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE))
# 
#   

FitFlextableToPage(index_tab)

```
## Country SPI overall scores over time

*Table A.2: SPI overall scores over time*
```{r tabtime, echo=FALSE}

#colors
col_palette <- c("#2ec4b6", "#acece7", "#f1dc76",  "#ffbf69","#ff9f1c"   )

col_palette2 <- c("#2ec4b6",  "#f1dc76", "#ff9f1c" )

#make the table
index_tab_time <- spi_index_df %>%
  select(iso3c, date, SPI.INDEX) %>%
  mutate(SPI.INDEX=round(SPI.INDEX,1)) %>%
  filter(!is.na(SPI.INDEX)) %>%
  pivot_wider(
    names_from=date,
    values_from=SPI.INDEX,
    names_prefix='SPI.INDEX.'
  ) %>%
  left_join(country_metadata) %>%
  select(country, starts_with('SPI.INDEX')) 

#quintile groups
        brks <- quantile(index_tab_time$SPI.INDEX.2021, probs=c(1,2,3,4)/5,na.rm=T)
        brks <- append(0,brks)
        brks <- append(brks,100)
        brks1 <- quantile(index_tab_time$SPI.INDEX.2020, probs=c(1,2,3,4)/5,na.rm=T)
        brks1 <- append(0,brks1)
        if (max(brks1)<100) brks1 <- append(brks1,100)
        
        brks2 <- quantile(index_tab_time$SPI.INDEX.2019, probs=c(1,2,3,4)/5,na.rm=T)
        brks2 <- append(0,brks2)
        if (max(brks2)<100) brks2 <- append(brks2,100)
        
        brks3 <- quantile(index_tab_time$SPI.INDEX.2018, probs=c(1,2,3,4)/5,na.rm=T)
        brks3 <- append(0,brks3)
        if (max(brks3)<100) brks3 <- append(brks3,100)
        
        brks4 <- quantile(index_tab_time$SPI.INDEX.2017, probs=c(1,2,3,4)/5,na.rm=T)
        brks4 <- append(0,brks4)
        if (max(brks4)<100) brks4 <- append(brks4,100)
        brks5 <- quantile(index_tab_time$SPI.INDEX.2016, probs=c(1,2,3,4)/5,na.rm=T)
        brks5 <- append(0,brks5)
        if (max(brks5)<100) brks5 <- append(brks5,100)
        brks6 <- quantile(index_tab_time$SPI.INDEX.2022, probs=c(1,2,3,4)/5,na.rm=T)
        brks6 <- append(0,brks6)
        if (max(brks6)<100) brks6 <- append(brks6,100)

#make nice looking
index_tab_time <- index_tab_time %>%
  flextable() %>%
  add_header_lines('SPI overall scores over time') %>%
  set_header_labels(values=list(
                       country="Country", 
                       SPI.INDEX.2022="2022",
                       SPI.INDEX.2021="2021",
                       SPI.INDEX.2020="2020",
                       SPI.INDEX.2019="2019",
                       SPI.INDEX.2018="2018",
                       SPI.INDEX.2017="2017",
                       SPI.INDEX.2016="2016"
                                   )) %>%
    bg(j = c('SPI.INDEX.2022'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks6, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2021'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2020'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks1, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2019'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks2, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2018'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks3, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2017'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks4, reverse=TRUE)) %>%
    bg(j = c('SPI.INDEX.2016'),
       bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks5, reverse=TRUE))

  

FitFlextableToPage(index_tab_time)

```


